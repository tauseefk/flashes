var Fj=Object.create;var NA=Object.defineProperty;var Gj=Object.getOwnPropertyDescriptor;var Ij=Object.getOwnPropertyNames;var bj=Object.getPrototypeOf,yj=Object.prototype.hasOwnProperty;var $j=(e,A)=>()=>(A||e((A={exports:{}}).exports,A),A.exports),X=(e,A)=>{for(var t in A)NA(e,t,{get:A[t],enumerable:!0})},Pj=(e,A,t,j)=>{if(A&&typeof A=="object"||typeof A=="function")for(let r of Ij(A))!yj.call(e,r)&&r!==t&&NA(e,r,{get:()=>A[r],enumerable:!(j=Gj(A,r))||j.enumerable});return e};var Xe=(e,A,t)=>(t=e!=null?Fj(bj(e)):{},Pj(A||!e||!e.__esModule?NA(t,"default",{value:e,enumerable:!0}):t,e));var Ie=$j((gn,Ge)=>{"use strict";var B={};B.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)};B.localCName=B.generateIdentifier();B.splitLines=function(e){return e.trim().split(`
`).map(A=>A.trim())};B.splitSections=function(e){return e.split(`
m=`).map((t,j)=>(j>0?"m="+t:t).trim()+`\r
`)};B.getDescription=function(e){let A=B.splitSections(e);return A&&A[0]};B.getMediaSections=function(e){let A=B.splitSections(e);return A.shift(),A};B.matchPrefix=function(e,A){return B.splitLines(e).filter(t=>t.indexOf(A)===0)};B.parseCandidate=function(e){let A;e.indexOf("a=candidate:")===0?A=e.substring(12).split(" "):A=e.substring(10).split(" ");let t={foundation:A[0],component:{1:"rtp",2:"rtcp"}[A[1]]||A[1],protocol:A[2].toLowerCase(),priority:parseInt(A[3],10),ip:A[4],address:A[4],port:parseInt(A[5],10),type:A[7]};for(let j=8;j<A.length;j+=2)switch(A[j]){case"raddr":t.relatedAddress=A[j+1];break;case"rport":t.relatedPort=parseInt(A[j+1],10);break;case"tcptype":t.tcpType=A[j+1];break;case"ufrag":t.ufrag=A[j+1],t.usernameFragment=A[j+1];break;default:t[A[j]]===void 0&&(t[A[j]]=A[j+1]);break}return t};B.writeCandidate=function(e){let A=[];A.push(e.foundation);let t=e.component;t==="rtp"?A.push(1):t==="rtcp"?A.push(2):A.push(t),A.push(e.protocol.toUpperCase()),A.push(e.priority),A.push(e.address||e.ip),A.push(e.port);let j=e.type;return A.push("typ"),A.push(j),j!=="host"&&e.relatedAddress&&e.relatedPort&&(A.push("raddr"),A.push(e.relatedAddress),A.push("rport"),A.push(e.relatedPort)),e.tcpType&&e.protocol.toLowerCase()==="tcp"&&(A.push("tcptype"),A.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(A.push("ufrag"),A.push(e.usernameFragment||e.ufrag)),"candidate:"+A.join(" ")};B.parseIceOptions=function(e){return e.substring(14).split(" ")};B.parseRtpMap=function(e){let A=e.substring(9).split(" "),t={payloadType:parseInt(A.shift(),10)};return A=A[0].split("/"),t.name=A[0],t.clockRate=parseInt(A[1],10),t.channels=A.length===3?parseInt(A[2],10):1,t.numChannels=t.channels,t};B.writeRtpMap=function(e){let A=e.payloadType;e.preferredPayloadType!==void 0&&(A=e.preferredPayloadType);let t=e.channels||e.numChannels||1;return"a=rtpmap:"+A+" "+e.name+"/"+e.clockRate+(t!==1?"/"+t:"")+`\r
`};B.parseExtmap=function(e){let A=e.substring(9).split(" ");return{id:parseInt(A[0],10),direction:A[0].indexOf("/")>0?A[0].split("/")[1]:"sendrecv",uri:A[1],attributes:A.slice(2).join(" ")}};B.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+`\r
`};B.parseFmtp=function(e){let A={},t,j=e.substring(e.indexOf(" ")+1).split(";");for(let r=0;r<j.length;r++)t=j[r].trim().split("="),A[t[0].trim()]=t[1];return A};B.writeFmtp=function(e){let A="",t=e.payloadType;if(e.preferredPayloadType!==void 0&&(t=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){let j=[];Object.keys(e.parameters).forEach(r=>{e.parameters[r]!==void 0?j.push(r+"="+e.parameters[r]):j.push(r)}),A+="a=fmtp:"+t+" "+j.join(";")+`\r
`}return A};B.parseRtcpFb=function(e){let A=e.substring(e.indexOf(" ")+1).split(" ");return{type:A.shift(),parameter:A.join(" ")}};B.writeRtcpFb=function(e){let A="",t=e.payloadType;return e.preferredPayloadType!==void 0&&(t=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(j=>{A+="a=rtcp-fb:"+t+" "+j.type+(j.parameter&&j.parameter.length?" "+j.parameter:"")+`\r
`}),A};B.parseSsrcMedia=function(e){let A=e.indexOf(" "),t={ssrc:parseInt(e.substring(7,A),10)},j=e.indexOf(":",A);return j>-1?(t.attribute=e.substring(A+1,j),t.value=e.substring(j+1)):t.attribute=e.substring(A+1),t};B.parseSsrcGroup=function(e){let A=e.substring(13).split(" ");return{semantics:A.shift(),ssrcs:A.map(t=>parseInt(t,10))}};B.getMid=function(e){let A=B.matchPrefix(e,"a=mid:")[0];if(A)return A.substring(6)};B.parseFingerprint=function(e){let A=e.substring(14).split(" ");return{algorithm:A[0].toLowerCase(),value:A[1].toUpperCase()}};B.getDtlsParameters=function(e,A){return{role:"auto",fingerprints:B.matchPrefix(e+A,"a=fingerprint:").map(B.parseFingerprint)}};B.writeDtlsParameters=function(e,A){let t="a=setup:"+A+`\r
`;return e.fingerprints.forEach(j=>{t+="a=fingerprint:"+j.algorithm+" "+j.value+`\r
`}),t};B.parseCryptoLine=function(e){let A=e.substring(9).split(" ");return{tag:parseInt(A[0],10),cryptoSuite:A[1],keyParams:A[2],sessionParams:A.slice(3)}};B.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams=="object"?B.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+`\r
`};B.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;let A=e.substring(7).split("|");return{keyMethod:"inline",keySalt:A[0],lifeTime:A[1],mkiValue:A[2]?A[2].split(":")[0]:void 0,mkiLength:A[2]?A[2].split(":")[1]:void 0}};B.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")};B.getCryptoParameters=function(e,A){return B.matchPrefix(e+A,"a=crypto:").map(B.parseCryptoLine)};B.getIceParameters=function(e,A){let t=B.matchPrefix(e+A,"a=ice-ufrag:")[0],j=B.matchPrefix(e+A,"a=ice-pwd:")[0];return t&&j?{usernameFragment:t.substring(12),password:j.substring(10)}:null};B.writeIceParameters=function(e){let A="a=ice-ufrag:"+e.usernameFragment+`\r
a=ice-pwd:`+e.password+`\r
`;return e.iceLite&&(A+=`a=ice-lite\r
`),A};B.parseRtpParameters=function(e){let A={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},j=B.splitLines(e)[0].split(" ");A.profile=j[2];for(let n=3;n<j.length;n++){let s=j[n],i=B.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(i){let o=B.parseRtpMap(i),a=B.matchPrefix(e,"a=fmtp:"+s+" ");switch(o.parameters=a.length?B.parseFmtp(a[0]):{},o.rtcpFeedback=B.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(B.parseRtcpFb),A.codecs.push(o),o.name.toUpperCase()){case"RED":case"ULPFEC":A.fecMechanisms.push(o.name.toUpperCase());break;default:break}}}B.matchPrefix(e,"a=extmap:").forEach(n=>{A.headerExtensions.push(B.parseExtmap(n))});let r=B.matchPrefix(e,"a=rtcp-fb:* ").map(B.parseRtcpFb);return A.codecs.forEach(n=>{r.forEach(s=>{n.rtcpFeedback.find(o=>o.type===s.type&&o.parameter===s.parameter)||n.rtcpFeedback.push(s)})}),A};B.writeRtpDescription=function(e,A){let t="";t+="m="+e+" ",t+=A.codecs.length>0?"9":"0",t+=" "+(A.profile||"UDP/TLS/RTP/SAVPF")+" ",t+=A.codecs.map(r=>r.preferredPayloadType!==void 0?r.preferredPayloadType:r.payloadType).join(" ")+`\r
`,t+=`c=IN IP4 0.0.0.0\r
`,t+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,A.codecs.forEach(r=>{t+=B.writeRtpMap(r),t+=B.writeFmtp(r),t+=B.writeRtcpFb(r)});let j=0;return A.codecs.forEach(r=>{r.maxptime>j&&(j=r.maxptime)}),j>0&&(t+="a=maxptime:"+j+`\r
`),A.headerExtensions&&A.headerExtensions.forEach(r=>{t+=B.writeExtmap(r)}),t};B.parseRtpEncodingParameters=function(e){let A=[],t=B.parseRtpParameters(e),j=t.fecMechanisms.indexOf("RED")!==-1,r=t.fecMechanisms.indexOf("ULPFEC")!==-1,n=B.matchPrefix(e,"a=ssrc:").map(k=>B.parseSsrcMedia(k)).filter(k=>k.attribute==="cname"),s=n.length>0&&n[0].ssrc,i,o=B.matchPrefix(e,"a=ssrc-group:FID").map(k=>k.substring(17).split(" ").map(l=>parseInt(l,10)));o.length>0&&o[0].length>1&&o[0][0]===s&&(i=o[0][1]),t.codecs.forEach(k=>{if(k.name.toUpperCase()==="RTX"&&k.parameters.apt){let c={ssrc:s,codecPayloadType:parseInt(k.parameters.apt,10)};s&&i&&(c.rtx={ssrc:i}),A.push(c),j&&(c=JSON.parse(JSON.stringify(c)),c.fec={ssrc:s,mechanism:r?"red+ulpfec":"red"},A.push(c))}}),A.length===0&&s&&A.push({ssrc:s});let a=B.matchPrefix(e,"b=");return a.length&&(a[0].indexOf("b=TIAS:")===0?a=parseInt(a[0].substring(7),10):a[0].indexOf("b=AS:")===0?a=parseInt(a[0].substring(5),10)*1e3*.95-2e3*8:a=void 0,A.forEach(k=>{k.maxBitrate=a})),A};B.parseRtcpParameters=function(e){let A={},t=B.matchPrefix(e,"a=ssrc:").map(n=>B.parseSsrcMedia(n)).filter(n=>n.attribute==="cname")[0];t&&(A.cname=t.value,A.ssrc=t.ssrc);let j=B.matchPrefix(e,"a=rtcp-rsize");A.reducedSize=j.length>0,A.compound=j.length===0;let r=B.matchPrefix(e,"a=rtcp-mux");return A.mux=r.length>0,A};B.writeRtcpParameters=function(e){let A="";return e.reducedSize&&(A+=`a=rtcp-rsize\r
`),e.mux&&(A+=`a=rtcp-mux\r
`),e.ssrc!==void 0&&e.cname&&(A+="a=ssrc:"+e.ssrc+" cname:"+e.cname+`\r
`),A};B.parseMsid=function(e){let A,t=B.matchPrefix(e,"a=msid:");if(t.length===1)return A=t[0].substring(7).split(" "),{stream:A[0],track:A[1]};let j=B.matchPrefix(e,"a=ssrc:").map(r=>B.parseSsrcMedia(r)).filter(r=>r.attribute==="msid");if(j.length>0)return A=j[0].value.split(" "),{stream:A[0],track:A[1]}};B.parseSctpDescription=function(e){let A=B.parseMLine(e),t=B.matchPrefix(e,"a=max-message-size:"),j;t.length>0&&(j=parseInt(t[0].substring(19),10)),isNaN(j)&&(j=65536);let r=B.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substring(12),10),protocol:A.fmt,maxMessageSize:j};let n=B.matchPrefix(e,"a=sctpmap:");if(n.length>0){let s=n[0].substring(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:j}}};B.writeSctpDescription=function(e,A){let t=[];return e.protocol!=="DTLS/SCTP"?t=["m="+e.kind+" 9 "+e.protocol+" "+A.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+A.port+`\r
`]:t=["m="+e.kind+" 9 "+e.protocol+" "+A.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+A.port+" "+A.protocol+` 65535\r
`],A.maxMessageSize!==void 0&&t.push("a=max-message-size:"+A.maxMessageSize+`\r
`),t.join("")};B.generateSessionId=function(){return Math.random().toString().substr(2,22)};B.writeSessionBoilerplate=function(e,A,t){let j,r=A!==void 0?A:2;return e?j=e:j=B.generateSessionId(),`v=0\r
o=`+(t||"thisisadapterortc")+" "+j+" "+r+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`};B.getDirection=function(e,A){let t=B.splitLines(e);for(let j=0;j<t.length;j++)switch(t[j]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return t[j].substring(2);default:}return A?B.getDirection(A):"sendrecv"};B.getKind=function(e){return B.splitLines(e)[0].split(" ")[0].substring(2)};B.isRejected=function(e){return e.split(" ",2)[1]==="0"};B.parseMLine=function(e){let t=B.splitLines(e)[0].substring(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}};B.parseOLine=function(e){let t=B.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}};B.isValidSDP=function(e){if(typeof e!="string"||e.length===0)return!1;let A=B.splitLines(e);for(let t=0;t<A.length;t++)if(A[t].length<2||A[t].charAt(1)!=="=")return!1;return!0};typeof Ge=="object"&&(Ge.exports=B)});var _=class z{subscribe;unsubscribe;constructor(A,t){this.subscribe=A,this.unsubscribe=t}compose(A){return A(this)}map(A){return this.compose(Kj(A))}switchMap(A){return this.compose(Mj(A))}filter(A){return this.compose(Tj(A))}debounceTime(A){return this.compose(Oj(A))}withLatestFrom(A){return this.compose(Sj(A))}static fromEvent(A,t){let j=new z(r=>(t.addEventListener(A,r.next),j.unsubscribe=()=>{r.complete(),t.removeEventListener(A,r.next)},j.unsubscribe));return j}static fromTimer(A){let t=new z(j=>{let r=0,n=setTimeout(()=>{r+=1,j.next(r)},A);return t.unsubscribe=()=>{j.complete(),clearTimeout(n)},t.unsubscribe});return t}static fromReadableStream(A){let t=new z(j=>{let r=async()=>{let n=A.getReader(),s=await n.read();n.releaseLock(),s.done?j.complete():j.next({value:s.value,done:s.done})};return t.unsubscribe=()=>{j.complete()},r(),t.unsubscribe});return t}static eagerFromReadableStream(A){let t=new z(j=>{let r=async()=>{let n=A.getReader(),s=await n.read();n.releaseLock(),s.done?j.complete():(j.next({value:s.value,done:s.done}),await r())};return t.unsubscribe=()=>{j.complete()},r(),t.unsubscribe});return t}static fromInterval(A){let t=new z(j=>{let r=0,n=setInterval(()=>{r+=1,j.next(r)},A);return t.unsubscribe=()=>{j.complete(),clearInterval(n)},t.unsubscribe});return t}};function Kj(e){return A=>{let t=new _(j=>(A.subscribe({next:r=>j.next(e(r)),complete:j.complete}),t.unsubscribe=()=>{typeof A.unsubscribe=="function"&&A.unsubscribe()},t.unsubscribe));return t}}var Cj=()=>{};function Tj(e){return A=>{let t=new _(j=>(A.subscribe({next:r=>e(r)?j.next(r):Cj(),complete:j.complete}),t.unsubscribe=()=>{typeof A.unsubscribe=="function"&&A.unsubscribe()},t.unsubscribe));return t}}function Oj(e){let A=null;return t=>{let j=new _(r=>(t.subscribe({next:n=>{A&&(clearTimeout(A),A=null),A=window.setTimeout(()=>r.next(n),e)},complete:()=>{A&&window.clearTimeout(A),r.complete()}}),j.unsubscribe=()=>{A&&window.clearTimeout(A),typeof t.unsubscribe=="function"&&t.unsubscribe()},j.unsubscribe));return j}}function Sj(e){let A,t,j=!1;return r=>{let n=new _(s=>(e.subscribe({next:i=>{A=i,s.next([A,t])},complete:()=>{if(!j){j=!0;return}s.complete()}}),r.subscribe({next:i=>{t=i,s.next([A,t])},complete:()=>{if(!j){j=!0;return}s.complete()}}),n.unsubscribe=()=>{typeof r.unsubscribe=="function"&&r.unsubscribe(),typeof e.unsubscribe=="function"&&e.unsubscribe()},n.unsubscribe));return n}}function Mj(e){let A=null;return t=>{let j=new _(r=>(t.subscribe({next:n=>{A?.unsubscribe?.(),A=e(n),A.subscribe(r)},complete:()=>r.complete()}),j.unsubscribe=()=>{A?.unsubscribe?.(),t?.unsubscribe?.(),r.complete()},j.unsubscribe));return j}}var JA={};X(JA,{__externref_drop_slice:()=>Rr,__externref_table_alloc:()=>Or,__wbg_flashlight_free:()=>er,__wbg_get_flashlight_monster_poise:()=>or,__wbg_get_flashlight_player_poise:()=>sr,__wbg_get_flashlight_view_width:()=>rr,__wbg_get_flashlight_width:()=>tr,__wbg_get_mapmetadata_player_cell_idx:()=>Wj,__wbg_get_mapmetadata_target_cell_idx:()=>Jj,__wbg_get_mapmetadata_width:()=>Yj,__wbg_get_move_from:()=>Gr,__wbg_get_move_to:()=>br,__wbg_get_vec2_0:()=>Cr,__wbg_get_vec2_1:()=>mr,__wbg_mapmetadata_free:()=>Uj,__wbg_move_free:()=>Fr,__wbg_set_flashlight_monster_poise:()=>ar,__wbg_set_flashlight_player_poise:()=>ir,__wbg_set_flashlight_view_width:()=>nr,__wbg_set_flashlight_width:()=>jr,__wbg_set_mapmetadata_player_cell_idx:()=>Zj,__wbg_set_mapmetadata_target_cell_idx:()=>Xj,__wbg_set_mapmetadata_width:()=>Ar,__wbg_set_move_from:()=>Ir,__wbg_set_move_to:()=>yr,__wbg_set_vec2_0:()=>Kr,__wbg_set_vec2_1:()=>gr,__wbg_vec2_free:()=>_r,__wbindgen_exn_store:()=>Tr,__wbindgen_export_2:()=>Sr,__wbindgen_free:()=>wr,__wbindgen_malloc:()=>Mr,__wbindgen_start:()=>UA,flashlight_apply_delta_js:()=>dr,flashlight_apply_initial_state_vector_js:()=>hr,flashlight_compute_visibility:()=>Er,flashlight_do_move_enemy:()=>qr,flashlight_do_move_player:()=>ur,flashlight_get_clipped_map_state:()=>Br,flashlight_is_solvable:()=>fr,flashlight_map_metadata:()=>lr,flashlight_new:()=>kr,flashlight_new_from_js:()=>cr,flashlight_visibility_state:()=>pr,instance:()=>h,memory:()=>Qj,module:()=>Vj,move_new:()=>$r,move_new_with_data:()=>Pr,vec2_new:()=>xr,vec2_new_with_data:()=>vr});var We="./flashlight_bg-LBBSXTLU.wasm";var E;function et(e){E=e}function H(e){let A=E.__externref_table_alloc();return E.__wbindgen_export_2.set(A,e),A}function Z(e,A){try{return e.apply(this,A)}catch(t){let j=H(t);E.__wbindgen_exn_store(j)}}var wj=typeof TextDecoder>"u"?(0,module.require)("util").TextDecoder:TextDecoder,tt=new wj("utf-8",{ignoreBOM:!0,fatal:!0});tt.decode();var hA=null;function jt(){return(hA===null||hA.byteLength===0)&&(hA=new Uint8Array(E.memory.buffer)),hA}function QA(e,A){return e=e>>>0,tt.decode(jt().subarray(e,e+A))}function rt(e,A){return e=e>>>0,jt().subarray(e/1,e/1+A)}function D(e){return e==null}var L=null;function dA(){return(L===null||L.buffer.detached===!0||L.buffer.detached===void 0&&L.buffer!==E.memory.buffer)&&(L=new DataView(E.memory.buffer)),L}var nt=0;function zj(e,A){let t=A(e.length*4,4)>>>0;for(let j=0;j<e.length;j++){let r=H(e[j]);dA().setUint32(t+4*j,r,!0)}return nt=e.length,t}function Lj(e,A){e=e>>>0;let t=dA(),j=[];for(let r=e;r<e+4*A;r+=4)j.push(E.__wbindgen_export_2.get(t.getUint32(r,!0)));return E.__externref_drop_slice(e,A),j}function Dj(e,A){if(!(e instanceof A))throw new Error(`expected instance of ${A.name}`)}var on=Object.freeze({Target:0,0:"Target",Water:1,1:"Water",Tree:2,2:"Tree",Rock:3,3:"Rock",Floor:4,4:"Floor",Player:5,5:"Player",Monster:6,6:"Monster",DefeatedMonster:7,7:"DefeatedMonster"}),Y=Object.freeze({NoOp:0,0:"NoOp",Rejected:1,1:"Rejected",Advance:2,2:"Advance",End:3,3:"End"}),Ze=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>E.__wbg_flashlight_free(e>>>0,1)),uA=class e{static __wrap(A){A=A>>>0;let t=Object.create(e.prototype);return t.__wbg_ptr=A,Ze.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){let A=this.__wbg_ptr;return this.__wbg_ptr=0,Ze.unregister(this),A}free(){let A=this.__destroy_into_raw();E.__wbg_flashlight_free(A,0)}get width(){return E.__wbg_get_flashlight_width(this.__wbg_ptr)}set width(A){E.__wbg_set_flashlight_width(this.__wbg_ptr,A)}get view_width(){return E.__wbg_get_flashlight_view_width(this.__wbg_ptr)}set view_width(A){E.__wbg_set_flashlight_view_width(this.__wbg_ptr,A)}get player_poise(){return E.__wbg_get_flashlight_player_poise(this.__wbg_ptr)}set player_poise(A){E.__wbg_set_flashlight_player_poise(this.__wbg_ptr,A)}get monster_poise(){return E.__wbg_get_flashlight_monster_poise(this.__wbg_ptr)}set monster_poise(A){E.__wbg_set_flashlight_monster_poise(this.__wbg_ptr,A)}static new(A,t,j,r){let n=zj(A,E.__wbindgen_malloc),s=nt,i=E.flashlight_new(n,s,t,j,r);return e.__wrap(i)}static new_from_js(A,t,j,r){let n=E.flashlight_new_from_js(A,t,j,r);return e.__wrap(n)}get_clipped_map_state(){let A=E.flashlight_get_clipped_map_state(this.__wbg_ptr);var t=Lj(A[0],A[1]).slice();return E.__wbindgen_free(A[0],A[1]*4,4),t}get map_metadata(){let A=E.flashlight_map_metadata(this.__wbg_ptr);return VA.__wrap(A)}get visibility_state(){return E.flashlight_visibility_state(this.__wbg_ptr)}compute_visibility(){E.flashlight_compute_visibility(this.__wbg_ptr)}apply_initial_state_vector_js(A){E.flashlight_apply_initial_state_vector_js(this.__wbg_ptr,A)}apply_delta_js(A){E.flashlight_apply_delta_js(this.__wbg_ptr,A)}do_move_player(A){Dj(A,W);var t=A.__destroy_into_raw();return E.flashlight_do_move_player(this.__wbg_ptr,t)}is_solvable(){return E.flashlight_is_solvable(this.__wbg_ptr)!==0}do_move_enemy(){return E.flashlight_do_move_enemy(this.__wbg_ptr)}},Ye=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>E.__wbg_mapmetadata_free(e>>>0,1)),VA=class e{static __wrap(A){A=A>>>0;let t=Object.create(e.prototype);return t.__wbg_ptr=A,Ye.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){let A=this.__wbg_ptr;return this.__wbg_ptr=0,Ye.unregister(this),A}free(){let A=this.__destroy_into_raw();E.__wbg_mapmetadata_free(A,0)}get target_cell_idx(){return E.__wbg_get_mapmetadata_target_cell_idx(this.__wbg_ptr)}set target_cell_idx(A){E.__wbg_set_mapmetadata_target_cell_idx(this.__wbg_ptr,A)}get player_cell_idx(){return E.__wbg_get_mapmetadata_player_cell_idx(this.__wbg_ptr)}set player_cell_idx(A){E.__wbg_set_mapmetadata_player_cell_idx(this.__wbg_ptr,A)}get width(){return E.__wbg_get_mapmetadata_width(this.__wbg_ptr)}set width(A){E.__wbg_set_mapmetadata_width(this.__wbg_ptr,A)}},an=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>E.__wbg_move_free(e>>>0,1));var At=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>E.__wbg_vec2_free(e>>>0,1)),W=class e{static __wrap(A){A=A>>>0;let t=Object.create(e.prototype);return t.__wbg_ptr=A,At.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){let A=this.__wbg_ptr;return this.__wbg_ptr=0,At.unregister(this),A}free(){let A=this.__destroy_into_raw();E.__wbg_vec2_free(A,0)}get 0(){return E.__wbg_get_mapmetadata_player_cell_idx(this.__wbg_ptr)}set 0(A){E.__wbg_set_mapmetadata_player_cell_idx(this.__wbg_ptr,A)}get 1(){return E.__wbg_get_vec2_1(this.__wbg_ptr)}set 1(A){E.__wbg_set_vec2_1(this.__wbg_ptr,A)}static new(){let A=E.vec2_new();return e.__wrap(A)}static new_with_data(A,t){let j=E.vec2_new_with_data(A,t);return e.__wrap(j)}};function st(e){return e.buffer}function it(){return Z(function(e,A){return e.call(A)},arguments)}function ot(){return Z(function(e,A,t){return e.call(A,t)},arguments)}function at(e){return e.crypto}function kt(){return Z(function(e,A){e.getRandomValues(A)},arguments)}function ct(e){return e.length}function Bt(e){return e.msCrypto}function lt(e){return new Uint8Array(e)}function pt(e){return new Int32Array(e)}function Et(e,A){return new Function(QA(e,A))}function ht(e,A,t){return new Int32Array(e,A>>>0,t>>>0)}function dt(e,A,t){return new Uint8Array(e,A>>>0,t>>>0)}function ut(e){return new Uint8Array(e>>>0)}function ft(e){return e.node}function qt(e){return e.process}function _t(){return Z(function(e,A){e.randomFillSync(A)},arguments)}function mt(){return Z(function(){return module.require},arguments)}function gt(e,A){sendDelta(rt(e,A))}function xt(e,A){sendInitialStateVector(rt(e,A))}function vt(e,A,t){e.set(A,t>>>0)}function Ft(){let e=typeof global>"u"?null:global;return D(e)?0:H(e)}function Gt(){let e=typeof globalThis>"u"?null:globalThis;return D(e)?0:H(e)}function It(){let e=typeof self>"u"?null:self;return D(e)?0:H(e)}function bt(){let e=typeof window>"u"?null:window;return D(e)?0:H(e)}function yt(e,A,t){return e.subarray(A>>>0,t>>>0)}function $t(e){return e.versions}function Pt(){let e=E.__wbindgen_export_2,A=e.grow(4);e.set(0,void 0),e.set(A+0,void 0),e.set(A+1,null),e.set(A+2,!0),e.set(A+3,!1)}function Kt(e){return typeof e=="function"}function Ct(e){let A=e;return typeof A=="object"&&A!==null}function Tt(e){return typeof e=="string"}function Ot(e){return e===void 0}function St(){return E.memory}function Mt(e,A){let t=A,j=typeof t=="number"?t:void 0;dA().setFloat64(e+8,D(j)?0:j,!0),dA().setInt32(e+0,!D(j),!0)}function Rt(e){return e}function wt(e,A){return QA(e,A)}function zt(e,A){throw new Error(QA(e,A))}function Lt(e){let A;try{A=+e}catch(j){A=j}return A}var Hj={"./flashlight_bg.js":{__wbg_sendInitialStateVector_4b929691eae4fdea:xt,__wbindgen_try_into_number:Lt,__wbindgen_number_get:Mt,__wbindgen_number_new:Rt,__wbindgen_memory:St,__wbg_buffer_609cc3eee51ed158:st,__wbg_newwithbyteoffsetandlength_999332a180064b59:ht,__wbg_new_e9a4a67dbababe57:pt,__wbg_sendDelta_c30907aca36281e8:gt,__wbg_subarray_aa9065fa9dc5df96:yt,__wbg_getRandomValues_b8f5dbd5f3995a9e:kt,__wbg_new_a12002a7f91c75be:lt,__wbg_set_65595bdd868b3009:vt,__wbg_newwithbyteoffsetandlength_d97e637ebe145a9a:dt,__wbg_randomFillSync_ac0988aba3254290:_t,__wbg_crypto_574e78ad8b13b65f:at,__wbindgen_is_object:Ct,__wbg_process_dc0fbacc7c1c06f7:qt,__wbg_versions_c01dfd4722a88165:$t,__wbg_node_905d3e251edff8a2:ft,__wbindgen_is_string:Tt,__wbg_require_60cc747a6bc5215a:mt,__wbindgen_is_function:Kt,__wbindgen_string_new:wt,__wbg_call_7cccdd69e0791ae2:ot,__wbg_msCrypto_a61aeb35a24c1329:Bt,__wbg_newwithlength_a381634e90c276d4:ut,__wbindgen_is_undefined:Ot,__wbg_newnoargs_105ed471475aaf50:Et,__wbg_call_672a4d21634d4a24:it,__wbg_static_accessor_GLOBAL_88a902d13a557d07:Ft,__wbg_static_accessor_GLOBAL_THIS_56578be7e9f832b0:Gt,__wbg_static_accessor_WINDOW_5de37043a91a9c40:bt,__wbg_static_accessor_SELF_37c5d418e4bf5819:It,__wbg_length_a446193dc22c12f8:ct,__wbindgen_throw:zt,__wbindgen_init_externref_table:Pt}};async function Nj(e,A){if(typeof e=="string"){e.startsWith("./")&&(e=new URL(e,import.meta.url).href);let t=await fetch(e);if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,A)}catch(j){if(t.headers.get("Content-Type")!="application/wasm")console.warn(j);else throw j}e=await t.arrayBuffer()}return await WebAssembly.instantiate(e,A)}var{instance:h,module:Vj}=await Nj(We,Hj),Qj=h.exports.memory,Uj=h.exports.__wbg_mapmetadata_free,Jj=h.exports.__wbg_get_mapmetadata_target_cell_idx,Xj=h.exports.__wbg_set_mapmetadata_target_cell_idx,Wj=h.exports.__wbg_get_mapmetadata_player_cell_idx,Zj=h.exports.__wbg_set_mapmetadata_player_cell_idx,Yj=h.exports.__wbg_get_mapmetadata_width,Ar=h.exports.__wbg_set_mapmetadata_width,er=h.exports.__wbg_flashlight_free,tr=h.exports.__wbg_get_flashlight_width,jr=h.exports.__wbg_set_flashlight_width,rr=h.exports.__wbg_get_flashlight_view_width,nr=h.exports.__wbg_set_flashlight_view_width,sr=h.exports.__wbg_get_flashlight_player_poise,ir=h.exports.__wbg_set_flashlight_player_poise,or=h.exports.__wbg_get_flashlight_monster_poise,ar=h.exports.__wbg_set_flashlight_monster_poise,kr=h.exports.flashlight_new,cr=h.exports.flashlight_new_from_js,Br=h.exports.flashlight_get_clipped_map_state,lr=h.exports.flashlight_map_metadata,pr=h.exports.flashlight_visibility_state,Er=h.exports.flashlight_compute_visibility,hr=h.exports.flashlight_apply_initial_state_vector_js,dr=h.exports.flashlight_apply_delta_js,ur=h.exports.flashlight_do_move_player,fr=h.exports.flashlight_is_solvable,qr=h.exports.flashlight_do_move_enemy,_r=h.exports.__wbg_vec2_free,mr=h.exports.__wbg_get_vec2_1,gr=h.exports.__wbg_set_vec2_1,xr=h.exports.vec2_new,vr=h.exports.vec2_new_with_data,Fr=h.exports.__wbg_move_free,Gr=h.exports.__wbg_get_move_from,Ir=h.exports.__wbg_set_move_from,br=h.exports.__wbg_get_move_to,yr=h.exports.__wbg_set_move_to,$r=h.exports.move_new,Pr=h.exports.move_new_with_data,Kr=h.exports.__wbg_set_vec2_0,Cr=h.exports.__wbg_get_vec2_0,Tr=h.exports.__wbindgen_exn_store,Or=h.exports.__externref_table_alloc,Sr=h.exports.__wbindgen_export_2,Mr=h.exports.__wbindgen_malloc,Rr=h.exports.__externref_drop_slice,wr=h.exports.__wbindgen_free,UA=h.exports.__wbindgen_start;et(JA);UA();var XA=class{constructor(){this.encoder=new TextEncoder,this._pieces=[],this._parts=[]}append_buffer(A){this.flush(),this._parts.push(A)}append(A){this._pieces.push(A)}flush(){if(this._pieces.length>0){let A=new Uint8Array(this._pieces);this._parts.push(A),this._pieces=[]}}toArrayBuffer(){let A=[];for(let t of this._parts)A.push(t);return zr(A).buffer}};function zr(e){let A=0;for(let r of e)A+=r.byteLength;let t=new Uint8Array(A),j=0;for(let r of e){let n=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);t.set(n,j),j+=r.byteLength}return t}function YA(e){return new WA(e).unpack()}function Ae(e){let A=new ZA,t=A.pack(e);return t instanceof Promise?t.then(()=>A.getBuffer()):A.getBuffer()}var WA=class{constructor(A){this.index=0,this.dataBuffer=A,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}unpack(){let A=this.unpack_uint8();if(A<128)return A;if((A^224)<32)return(A^224)-32;let t;if((t=A^160)<=15)return this.unpack_raw(t);if((t=A^176)<=15)return this.unpack_string(t);if((t=A^144)<=15)return this.unpack_array(t);if((t=A^128)<=15)return this.unpack_map(t);switch(A){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return;case 213:return;case 214:return;case 215:return;case 216:return t=this.unpack_uint16(),this.unpack_string(t);case 217:return t=this.unpack_uint32(),this.unpack_string(t);case 218:return t=this.unpack_uint16(),this.unpack_raw(t);case 219:return t=this.unpack_uint32(),this.unpack_raw(t);case 220:return t=this.unpack_uint16(),this.unpack_array(t);case 221:return t=this.unpack_uint32(),this.unpack_array(t);case 222:return t=this.unpack_uint16(),this.unpack_map(t);case 223:return t=this.unpack_uint32(),this.unpack_map(t)}}unpack_uint8(){let A=this.dataView[this.index]&255;return this.index++,A}unpack_uint16(){let A=this.read(2),t=(A[0]&255)*256+(A[1]&255);return this.index+=2,t}unpack_uint32(){let A=this.read(4),t=((A[0]*256+A[1])*256+A[2])*256+A[3];return this.index+=4,t}unpack_uint64(){let A=this.read(8),t=((((((A[0]*256+A[1])*256+A[2])*256+A[3])*256+A[4])*256+A[5])*256+A[6])*256+A[7];return this.index+=8,t}unpack_int8(){let A=this.unpack_uint8();return A<128?A:A-256}unpack_int16(){let A=this.unpack_uint16();return A<32768?A:A-65536}unpack_int32(){let A=this.unpack_uint32();return A<2**31?A:A-2**32}unpack_int64(){let A=this.unpack_uint64();return A<2**63?A:A-2**64}unpack_raw(A){if(this.length<this.index+A)throw new Error(`BinaryPackFailure: index is out of range ${this.index} ${A} ${this.length}`);let t=this.dataBuffer.slice(this.index,this.index+A);return this.index+=A,t}unpack_string(A){let t=this.read(A),j=0,r="",n,s;for(;j<A;)n=t[j],n<160?(s=n,j++):(n^192)<32?(s=(n&31)<<6|t[j+1]&63,j+=2):(n^224)<16?(s=(n&15)<<12|(t[j+1]&63)<<6|t[j+2]&63,j+=3):(s=(n&7)<<18|(t[j+1]&63)<<12|(t[j+2]&63)<<6|t[j+3]&63,j+=4),r+=String.fromCodePoint(s);return this.index+=A,r}unpack_array(A){let t=new Array(A);for(let j=0;j<A;j++)t[j]=this.unpack();return t}unpack_map(A){let t={};for(let j=0;j<A;j++){let r=this.unpack();t[r]=this.unpack()}return t}unpack_float(){let A=this.unpack_uint32(),t=A>>31,j=(A>>23&255)-127,r=A&8388607|8388608;return(t===0?1:-1)*r*2**(j-23)}unpack_double(){let A=this.unpack_uint32(),t=this.unpack_uint32(),j=A>>31,r=(A>>20&2047)-1023,s=(A&1048575|1048576)*2**(r-20)+t*2**(r-52);return(j===0?1:-1)*s}read(A){let t=this.index;if(t+A<=this.length)return this.dataView.subarray(t,t+A);throw new Error("BinaryPackFailure: read index out of range")}},ZA=class{getBuffer(){return this._bufferBuilder.toArrayBuffer()}pack(A){if(typeof A=="string")this.pack_string(A);else if(typeof A=="number")Math.floor(A)===A?this.pack_integer(A):this.pack_double(A);else if(typeof A=="boolean")A===!0?this._bufferBuilder.append(195):A===!1&&this._bufferBuilder.append(194);else if(A===void 0)this._bufferBuilder.append(192);else if(typeof A=="object")if(A===null)this._bufferBuilder.append(192);else{let t=A.constructor;if(A instanceof Array){let j=this.pack_array(A);if(j instanceof Promise)return j.then(()=>this._bufferBuilder.flush())}else if(A instanceof ArrayBuffer)this.pack_bin(new Uint8Array(A));else if("BYTES_PER_ELEMENT"in A){let j=A;this.pack_bin(new Uint8Array(j.buffer,j.byteOffset,j.byteLength))}else if(A instanceof Date)this.pack_string(A.toString());else{if(A instanceof Blob)return A.arrayBuffer().then(j=>{this.pack_bin(new Uint8Array(j)),this._bufferBuilder.flush()});if(t==Object||t.toString().startsWith("class")){let j=this.pack_object(A);if(j instanceof Promise)return j.then(()=>this._bufferBuilder.flush())}else throw new Error(`Type "${t.toString()}" not yet supported`)}}else throw new Error(`Type "${typeof A}" not yet supported`);this._bufferBuilder.flush()}pack_bin(A){let t=A.length;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this._bufferBuilder.append(218),this.pack_uint16(t);else if(t<=4294967295)this._bufferBuilder.append(219),this.pack_uint32(t);else throw new Error("Invalid length");this._bufferBuilder.append_buffer(A)}pack_string(A){let t=this._textEncoder.encode(A),j=t.length;if(j<=15)this.pack_uint8(176+j);else if(j<=65535)this._bufferBuilder.append(216),this.pack_uint16(j);else if(j<=4294967295)this._bufferBuilder.append(217),this.pack_uint32(j);else throw new Error("Invalid length");this._bufferBuilder.append_buffer(t)}pack_array(A){let t=A.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this._bufferBuilder.append(220),this.pack_uint16(t);else if(t<=4294967295)this._bufferBuilder.append(221),this.pack_uint32(t);else throw new Error("Invalid length");let j=r=>{if(r<t){let n=this.pack(A[r]);return n instanceof Promise?n.then(()=>j(r+1)):j(r+1)}};return j(0)}pack_integer(A){if(A>=-32&&A<=127)this._bufferBuilder.append(A&255);else if(A>=0&&A<=255)this._bufferBuilder.append(204),this.pack_uint8(A);else if(A>=-128&&A<=127)this._bufferBuilder.append(208),this.pack_int8(A);else if(A>=0&&A<=65535)this._bufferBuilder.append(205),this.pack_uint16(A);else if(A>=-32768&&A<=32767)this._bufferBuilder.append(209),this.pack_int16(A);else if(A>=0&&A<=4294967295)this._bufferBuilder.append(206),this.pack_uint32(A);else if(A>=-2147483648&&A<=2147483647)this._bufferBuilder.append(210),this.pack_int32(A);else if(A>=-9223372036854776e3&&A<=9223372036854776e3)this._bufferBuilder.append(211),this.pack_int64(A);else if(A>=0&&A<=18446744073709552e3)this._bufferBuilder.append(207),this.pack_uint64(A);else throw new Error("Invalid integer")}pack_double(A){let t=0;A<0&&(t=1,A=-A);let j=Math.floor(Math.log(A)/Math.LN2),r=A/2**j-1,n=Math.floor(r*2**52),s=2**32,i=t<<31|j+1023<<20|n/s&1048575,o=n%s;this._bufferBuilder.append(203),this.pack_int32(i),this.pack_int32(o)}pack_object(A){let t=Object.keys(A),j=t.length;if(j<=15)this.pack_uint8(128+j);else if(j<=65535)this._bufferBuilder.append(222),this.pack_uint16(j);else if(j<=4294967295)this._bufferBuilder.append(223),this.pack_uint32(j);else throw new Error("Invalid length");let r=n=>{if(n<t.length){let s=t[n];if(A.hasOwnProperty(s)){this.pack(s);let i=this.pack(A[s]);if(i instanceof Promise)return i.then(()=>r(n+1))}return r(n+1)}};return r(0)}pack_uint8(A){this._bufferBuilder.append(A)}pack_uint16(A){this._bufferBuilder.append(A>>8),this._bufferBuilder.append(A&255)}pack_uint32(A){let t=A&4294967295;this._bufferBuilder.append((t&4278190080)>>>24),this._bufferBuilder.append((t&16711680)>>>16),this._bufferBuilder.append((t&65280)>>>8),this._bufferBuilder.append(t&255)}pack_uint64(A){let t=A/4294967296,j=A%2**32;this._bufferBuilder.append((t&4278190080)>>>24),this._bufferBuilder.append((t&16711680)>>>16),this._bufferBuilder.append((t&65280)>>>8),this._bufferBuilder.append(t&255),this._bufferBuilder.append((j&4278190080)>>>24),this._bufferBuilder.append((j&16711680)>>>16),this._bufferBuilder.append((j&65280)>>>8),this._bufferBuilder.append(j&255)}pack_int8(A){this._bufferBuilder.append(A&255)}pack_int16(A){this._bufferBuilder.append((A&65280)>>8),this._bufferBuilder.append(A&255)}pack_int32(A){this._bufferBuilder.append(A>>>24&255),this._bufferBuilder.append((A&16711680)>>>16),this._bufferBuilder.append((A&65280)>>>8),this._bufferBuilder.append(A&255)}pack_int64(A){let t=Math.floor(A/4294967296),j=A%2**32;this._bufferBuilder.append((t&4278190080)>>>24),this._bufferBuilder.append((t&16711680)>>>16),this._bufferBuilder.append((t&65280)>>>8),this._bufferBuilder.append(t&255),this._bufferBuilder.append((j&4278190080)>>>24),this._bufferBuilder.append((j&16711680)>>>16),this._bufferBuilder.append((j&65280)>>>8),this._bufferBuilder.append(j&255)}constructor(){this._bufferBuilder=new XA,this._textEncoder=new TextEncoder}};var Ht=!0,Nt=!0;function N(e,A,t){let j=e.match(A);return j&&j.length>=t&&parseFloat(j[t],10)}function y(e,A,t){if(!e.RTCPeerConnection)return;let j=e.RTCPeerConnection.prototype,r=j.addEventListener;j.addEventListener=function(s,i){if(s!==A)return r.apply(this,arguments);let o=a=>{let k=t(a);k&&(i.handleEvent?i.handleEvent(k):i(k))};return this._eventMap=this._eventMap||{},this._eventMap[A]||(this._eventMap[A]=new Map),this._eventMap[A].set(i,o),r.apply(this,[s,o])};let n=j.removeEventListener;j.removeEventListener=function(s,i){if(s!==A||!this._eventMap||!this._eventMap[A])return n.apply(this,arguments);if(!this._eventMap[A].has(i))return n.apply(this,arguments);let o=this._eventMap[A].get(i);return this._eventMap[A].delete(i),this._eventMap[A].size===0&&delete this._eventMap[A],Object.keys(this._eventMap).length===0&&delete this._eventMap,n.apply(this,[s,o])},Object.defineProperty(j,"on"+A,{get(){return this["_on"+A]},set(s){this["_on"+A]&&(this.removeEventListener(A,this["_on"+A]),delete this["_on"+A]),s&&this.addEventListener(A,this["_on"+A]=s)},enumerable:!0,configurable:!0})}function Vt(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Ht=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function Qt(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Nt=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function fA(){if(typeof window=="object"){if(Ht)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function V(e,A){Nt&&console.warn(e+" is deprecated, please use "+A+" instead.")}function Ut(e){let A={browser:null,version:null};if(typeof e>"u"||!e.navigator||!e.navigator.userAgent)return A.browser="Not a browser.",A;let{navigator:t}=e;if(t.userAgentData&&t.userAgentData.brands){let j=t.userAgentData.brands.find(r=>r.brand==="Chromium");if(j)return{browser:"chrome",version:parseInt(j.version,10)}}if(t.mozGetUserMedia)A.browser="firefox",A.version=parseInt(N(t.userAgent,/Firefox\/(\d+)\./,1));else if(t.webkitGetUserMedia||e.isSecureContext===!1&&e.webkitRTCPeerConnection)A.browser="chrome",A.version=parseInt(N(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(e.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))A.browser="safari",A.version=parseInt(N(t.userAgent,/AppleWebKit\/(\d+)\./,1)),A.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype,A._safariVersion=N(t.userAgent,/Version\/(\d+(\.?\d+))/,1);else return A.browser="Not a supported browser.",A;return A}function Dt(e){return Object.prototype.toString.call(e)==="[object Object]"}function te(e){return Dt(e)?Object.keys(e).reduce(function(A,t){let j=Dt(e[t]),r=j?te(e[t]):e[t],n=j&&!Object.keys(r).length;return r===void 0||n?A:Object.assign(A,{[t]:r})},{}):e}function ee(e,A,t){!A||t.has(A.id)||(t.set(A.id,A),Object.keys(A).forEach(j=>{j.endsWith("Id")?ee(e,e.get(A[j]),t):j.endsWith("Ids")&&A[j].forEach(r=>{ee(e,e.get(r),t)})}))}function je(e,A,t){let j=t?"outbound-rtp":"inbound-rtp",r=new Map;if(A===null)return r;let n=[];return e.forEach(s=>{s.type==="track"&&s.trackIdentifier===A.id&&n.push(s)}),n.forEach(s=>{e.forEach(i=>{i.type===j&&i.trackId===s.id&&ee(e,i,r)})}),r}var mA={};X(mA,{fixNegotiationNeeded:()=>ae,shimAddTrackRemoveTrack:()=>oe,shimAddTrackRemoveTrackWithNative:()=>Xt,shimGetSendersWithDtmf:()=>se,shimGetUserMedia:()=>qA,shimMediaStream:()=>re,shimOnTrack:()=>ne,shimPeerConnection:()=>_A,shimSenderReceiverGetStats:()=>ie});var Jt=fA;function qA(e,A){let t=e&&e.navigator;if(!t.mediaDevices)return;let j=function(i){if(typeof i!="object"||i.mandatory||i.optional)return i;let o={};return Object.keys(i).forEach(a=>{if(a==="require"||a==="advanced"||a==="mediaSource")return;let k=typeof i[a]=="object"?i[a]:{ideal:i[a]};k.exact!==void 0&&typeof k.exact=="number"&&(k.min=k.max=k.exact);let c=function(l,d){return l?l+d.charAt(0).toUpperCase()+d.slice(1):d==="deviceId"?"sourceId":d};if(k.ideal!==void 0){o.optional=o.optional||[];let l={};typeof k.ideal=="number"?(l[c("min",a)]=k.ideal,o.optional.push(l),l={},l[c("max",a)]=k.ideal,o.optional.push(l)):(l[c("",a)]=k.ideal,o.optional.push(l))}k.exact!==void 0&&typeof k.exact!="number"?(o.mandatory=o.mandatory||{},o.mandatory[c("",a)]=k.exact):["min","max"].forEach(l=>{k[l]!==void 0&&(o.mandatory=o.mandatory||{},o.mandatory[c(l,a)]=k[l])})}),i.advanced&&(o.optional=(o.optional||[]).concat(i.advanced)),o},r=function(i,o){if(A.version>=61)return o(i);if(i=JSON.parse(JSON.stringify(i)),i&&typeof i.audio=="object"){let a=function(k,c,l){c in k&&!(l in k)&&(k[l]=k[c],delete k[c])};i=JSON.parse(JSON.stringify(i)),a(i.audio,"autoGainControl","googAutoGainControl"),a(i.audio,"noiseSuppression","googNoiseSuppression"),i.audio=j(i.audio)}if(i&&typeof i.video=="object"){let a=i.video.facingMode;a=a&&(typeof a=="object"?a:{ideal:a});let k=A.version<66;if(a&&(a.exact==="user"||a.exact==="environment"||a.ideal==="user"||a.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!k)){delete i.video.facingMode;let c;if(a.exact==="environment"||a.ideal==="environment"?c=["back","rear"]:(a.exact==="user"||a.ideal==="user")&&(c=["front"]),c)return t.mediaDevices.enumerateDevices().then(l=>{l=l.filter(q=>q.kind==="videoinput");let d=l.find(q=>c.some(f=>q.label.toLowerCase().includes(f)));return!d&&l.length&&c.includes("back")&&(d=l[l.length-1]),d&&(i.video.deviceId=a.exact?{exact:d.deviceId}:{ideal:d.deviceId}),i.video=j(i.video),Jt("chrome: "+JSON.stringify(i)),o(i)})}i.video=j(i.video)}return Jt("chrome: "+JSON.stringify(i)),o(i)},n=function(i){return A.version>=64?i:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[i.name]||i.name,message:i.message,constraint:i.constraint||i.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},s=function(i,o,a){r(i,k=>{t.webkitGetUserMedia(k,o,c=>{a&&a(n(c))})})};if(t.getUserMedia=s.bind(t),t.mediaDevices.getUserMedia){let i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(o){return r(o,a=>i(a).then(k=>{if(a.audio&&!k.getAudioTracks().length||a.video&&!k.getVideoTracks().length)throw k.getTracks().forEach(c=>{c.stop()}),new DOMException("","NotFoundError");return k},k=>Promise.reject(n(k))))}}}function re(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function ne(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});let A=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=j=>{j.stream.addEventListener("addtrack",r=>{let n;e.RTCPeerConnection.prototype.getReceivers?n=this.getReceivers().find(i=>i.track&&i.track.id===r.track.id):n={track:r.track};let s=new Event("track");s.track=r.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[j.stream],this.dispatchEvent(s)}),j.stream.getTracks().forEach(r=>{let n;e.RTCPeerConnection.prototype.getReceivers?n=this.getReceivers().find(i=>i.track&&i.track.id===r.id):n={track:r};let s=new Event("track");s.track=r,s.receiver=n,s.transceiver={receiver:n},s.streams=[j.stream],this.dispatchEvent(s)})},this.addEventListener("addstream",this._ontrackpoly)),A.apply(this,arguments)}}else y(e,"track",A=>(A.transceiver||Object.defineProperty(A,"transceiver",{value:{receiver:A.receiver}}),A))}function se(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){let A=function(r,n){return{track:n,get dtmf(){return this._dtmf===void 0&&(n.kind==="audio"?this._dtmf=r.createDTMFSender(n):this._dtmf=null),this._dtmf},_pc:r}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(i,o){let a=r.apply(this,arguments);return a||(a=A(this,i),this._senders.push(a)),a};let n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(i){n.apply(this,arguments);let o=this._senders.indexOf(i);o!==-1&&this._senders.splice(o,1)}}let t=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(n){this._senders=this._senders||[],t.apply(this,[n]),n.getTracks().forEach(s=>{this._senders.push(A(this,s))})};let j=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(n){this._senders=this._senders||[],j.apply(this,[n]),n.getTracks().forEach(s=>{let i=this._senders.find(o=>o.track===s);i&&this._senders.splice(this._senders.indexOf(i),1)})}}else if(typeof e=="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){let A=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){let j=A.apply(this,[]);return j.forEach(r=>r._pc=this),j},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function ie(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){let t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){let n=t.apply(this,[]);return n.forEach(s=>s._pc=this),n});let j=e.RTCPeerConnection.prototype.addTrack;j&&(e.RTCPeerConnection.prototype.addTrack=function(){let n=j.apply(this,arguments);return n._pc=this,n}),e.RTCRtpSender.prototype.getStats=function(){let n=this;return this._pc.getStats().then(s=>je(s,n.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){let t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){let r=t.apply(this,[]);return r.forEach(n=>n._pc=this),r}),y(e,"track",j=>(j.receiver._pc=j.srcElement,j)),e.RTCRtpReceiver.prototype.getStats=function(){let r=this;return this._pc.getStats().then(n=>je(n,r.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype))return;let A=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){let j=arguments[0],r,n,s;return this.getSenders().forEach(i=>{i.track===j&&(r?s=!0:r=i)}),this.getReceivers().forEach(i=>(i.track===j&&(n?s=!0:n=i),i.track===j)),s||r&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return A.apply(this,arguments)}}function Xt(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(s=>this._shimmedLocalStreams[s][0])};let A=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(s,i){if(!i)return A.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let o=A.apply(this,arguments);return this._shimmedLocalStreams[i.id]?this._shimmedLocalStreams[i.id].indexOf(o)===-1&&this._shimmedLocalStreams[i.id].push(o):this._shimmedLocalStreams[i.id]=[i,o],o};let t=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach(a=>{if(this.getSenders().find(c=>c.track===a))throw new DOMException("Track already exists.","InvalidAccessError")});let i=this.getSenders();t.apply(this,arguments);let o=this.getSenders().filter(a=>i.indexOf(a)===-1);this._shimmedLocalStreams[s.id]=[s].concat(o)};let j=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],j.apply(this,arguments)};let r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach(i=>{let o=this._shimmedLocalStreams[i].indexOf(s);o!==-1&&this._shimmedLocalStreams[i].splice(o,1),this._shimmedLocalStreams[i].length===1&&delete this._shimmedLocalStreams[i]}),r.apply(this,arguments)}}function oe(e,A){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&A.version>=65)return Xt(e);let t=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){let k=t.apply(this);return this._reverseStreams=this._reverseStreams||{},k.map(c=>this._reverseStreams[c.id])};let j=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(k){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},k.getTracks().forEach(c=>{if(this.getSenders().find(d=>d.track===c))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[k.id]){let c=new e.MediaStream(k.getTracks());this._streams[k.id]=c,this._reverseStreams[c.id]=k,k=c}j.apply(this,[k])};let r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(k){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[k.id]||k]),delete this._reverseStreams[this._streams[k.id]?this._streams[k.id].id:k.id],delete this._streams[k.id]},e.RTCPeerConnection.prototype.addTrack=function(k,c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find(f=>f===k))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(f=>f.track===k))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let q=this._streams[c.id];if(q)q.addTrack(k),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let f=new e.MediaStream([k]);this._streams[c.id]=f,this._reverseStreams[f.id]=c,this.addStream(f)}return this.getSenders().find(f=>f.track===k)};function n(a,k){let c=k.sdp;return Object.keys(a._reverseStreams||[]).forEach(l=>{let d=a._reverseStreams[l],q=a._streams[d.id];c=c.replace(new RegExp(q.id,"g"),d.id)}),new RTCSessionDescription({type:k.type,sdp:c})}function s(a,k){let c=k.sdp;return Object.keys(a._reverseStreams||[]).forEach(l=>{let d=a._reverseStreams[l],q=a._streams[d.id];c=c.replace(new RegExp(d.id,"g"),q.id)}),new RTCSessionDescription({type:k.type,sdp:c})}["createOffer","createAnswer"].forEach(function(a){let k=e.RTCPeerConnection.prototype[a],c={[a](){let l=arguments;return arguments.length&&typeof arguments[0]=="function"?k.apply(this,[q=>{let f=n(this,q);l[0].apply(null,[f])},q=>{l[1]&&l[1].apply(null,q)},arguments[2]]):k.apply(this,arguments).then(q=>n(this,q))}};e.RTCPeerConnection.prototype[a]=c[a]});let i=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?i.apply(this,arguments):(arguments[0]=s(this,arguments[0]),i.apply(this,arguments))};let o=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){let a=o.get.apply(this);return a.type===""?a:n(this,a)}}),e.RTCPeerConnection.prototype.removeTrack=function(k){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!k._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(k._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let l;Object.keys(this._streams).forEach(d=>{this._streams[d].getTracks().find(f=>k.track===f)&&(l=this._streams[d])}),l&&(l.getTracks().length===1?this.removeStream(this._reverseStreams[l.id]):l.removeTrack(k.track),this.dispatchEvent(new Event("negotiationneeded")))}}function _A(e,A){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&A.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){let j=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new(t==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),j.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]})}function ae(e,A){y(e,"negotiationneeded",t=>{let j=t.target;if(!((A.version<72||j.getConfiguration&&j.getConfiguration().sdpSemantics==="plan-b")&&j.signalingState!=="stable"))return t})}var vA={};X(vA,{shimAddTransceiver:()=>Ee,shimCreateAnswer:()=>ue,shimCreateOffer:()=>de,shimGetDisplayMedia:()=>Wt,shimGetParameters:()=>he,shimGetUserMedia:()=>gA,shimOnTrack:()=>ke,shimPeerConnection:()=>xA,shimRTCDataChannel:()=>pe,shimReceiverGetStats:()=>Be,shimRemoveStream:()=>le,shimSenderGetStats:()=>ce});function gA(e,A){let t=e&&e.navigator,j=e&&e.MediaStreamTrack;if(t.getUserMedia=function(r,n,s){V("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(r).then(n,s)},!(A.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){let r=function(s,i,o){i in s&&!(o in s)&&(s[o]=s[i],delete s[i])},n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s.audio,"autoGainControl","mozAutoGainControl"),r(s.audio,"noiseSuppression","mozNoiseSuppression")),n(s)},j&&j.prototype.getSettings){let s=j.prototype.getSettings;j.prototype.getSettings=function(){let i=s.apply(this,arguments);return r(i,"mozAutoGainControl","autoGainControl"),r(i,"mozNoiseSuppression","noiseSuppression"),i}}if(j&&j.prototype.applyConstraints){let s=j.prototype.applyConstraints;j.prototype.applyConstraints=function(i){return this.kind==="audio"&&typeof i=="object"&&(i=JSON.parse(JSON.stringify(i)),r(i,"autoGainControl","mozAutoGainControl"),r(i,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[i])}}}}function Wt(e,A){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(j){if(!(j&&j.video)){let r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return j.video===!0?j.video={mediaSource:A}:j.video.mediaSource=A,e.navigator.mediaDevices.getUserMedia(j)})}function ke(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function xA(e,A){if(typeof e!="object"||!(e.RTCPeerConnection||e.mozRTCPeerConnection))return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),A.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){let n=e.RTCPeerConnection.prototype[r],s={[r](){return arguments[0]=new(r==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[r]=s[r]});let t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},j=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){let[n,s,i]=arguments;return j.apply(this,[n||null]).then(o=>{if(A.version<53&&!s)try{o.forEach(a=>{a.type=t[a.type]||a.type})}catch(a){if(a.name!=="TypeError")throw a;o.forEach((k,c)=>{o.set(c,Object.assign({},k,{type:t[k.type]||k.type}))})}return o}).then(s,i)}}function ce(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender)||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;let A=e.RTCPeerConnection.prototype.getSenders;A&&(e.RTCPeerConnection.prototype.getSenders=function(){let r=A.apply(this,[]);return r.forEach(n=>n._pc=this),r});let t=e.RTCPeerConnection.prototype.addTrack;t&&(e.RTCPeerConnection.prototype.addTrack=function(){let r=t.apply(this,arguments);return r._pc=this,r}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Be(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender)||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;let A=e.RTCPeerConnection.prototype.getReceivers;A&&(e.RTCPeerConnection.prototype.getReceivers=function(){let j=A.apply(this,[]);return j.forEach(r=>r._pc=this),j}),y(e,"track",t=>(t.receiver._pc=t.srcElement,t)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function le(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){V("removeStream","removeTrack"),this.getSenders().forEach(j=>{j.track&&t.getTracks().includes(j.track)&&this.removeTrack(j)})})}function pe(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function Ee(e){if(!(typeof e=="object"&&e.RTCPeerConnection))return;let A=e.RTCPeerConnection.prototype.addTransceiver;A&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let j=arguments[1]&&arguments[1].sendEncodings;j===void 0&&(j=[]),j=[...j];let r=j.length>0;r&&j.forEach(s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let n=A.apply(this,arguments);if(r){let{sender:s}=n,i=s.getParameters();(!("encodings"in i)||i.encodings.length===1&&Object.keys(i.encodings[0]).length===0)&&(i.encodings=j,s.sendEncodings=j,this.setParametersPromises.push(s.setParameters(i).then(()=>{delete s.sendEncodings}).catch(()=>{delete s.sendEncodings})))}return n})}function he(e){if(!(typeof e=="object"&&e.RTCRtpSender))return;let A=e.RTCRtpSender.prototype.getParameters;A&&(e.RTCRtpSender.prototype.getParameters=function(){let j=A.apply(this,arguments);return"encodings"in j||(j.encodings=[].concat(this.sendEncodings||[{}])),j})}function de(e){if(!(typeof e=="object"&&e.RTCPeerConnection))return;let A=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>A.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):A.apply(this,arguments)}}function ue(e){if(!(typeof e=="object"&&e.RTCPeerConnection))return;let A=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>A.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):A.apply(this,arguments)}}var FA={};X(FA,{shimAudioContext:()=>Fe,shimCallbacksAPI:()=>_e,shimConstraints:()=>Zt,shimCreateOfferLegacy:()=>ve,shimGetUserMedia:()=>me,shimLocalStreamsAPI:()=>fe,shimRTCIceServerUrls:()=>ge,shimRemoteStreamsAPI:()=>qe,shimTrackEventTransceiver:()=>xe});function fe(e){if(!(typeof e!="object"||!e.RTCPeerConnection)){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){let A=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(j){this._localStreams||(this._localStreams=[]),this._localStreams.includes(j)||this._localStreams.push(j),j.getAudioTracks().forEach(r=>A.call(this,r,j)),j.getVideoTracks().forEach(r=>A.call(this,r,j))},e.RTCPeerConnection.prototype.addTrack=function(j,...r){return r&&r.forEach(n=>{this._localStreams?this._localStreams.includes(n)||this._localStreams.push(n):this._localStreams=[n]}),A.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);let j=this._localStreams.indexOf(t);if(j===-1)return;this._localStreams.splice(j,1);let r=t.getTracks();this.getSenders().forEach(n=>{r.includes(n.track)&&this.removeTrack(n)})})}}function qe(e){if(!(typeof e!="object"||!e.RTCPeerConnection)&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=j=>{j.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);let n=new Event("addstream");n.stream=r,this.dispatchEvent(n)})})}});let A=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){let j=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(n=>{if(j._remoteStreams||(j._remoteStreams=[]),j._remoteStreams.indexOf(n)>=0)return;j._remoteStreams.push(n);let s=new Event("addstream");s.stream=n,j.dispatchEvent(s)})}),A.apply(j,arguments)}}}function _e(e){if(typeof e!="object"||!e.RTCPeerConnection)return;let A=e.RTCPeerConnection.prototype,t=A.createOffer,j=A.createAnswer,r=A.setLocalDescription,n=A.setRemoteDescription,s=A.addIceCandidate;A.createOffer=function(a,k){let c=arguments.length>=2?arguments[2]:arguments[0],l=t.apply(this,[c]);return k?(l.then(a,k),Promise.resolve()):l},A.createAnswer=function(a,k){let c=arguments.length>=2?arguments[2]:arguments[0],l=j.apply(this,[c]);return k?(l.then(a,k),Promise.resolve()):l};let i=function(o,a,k){let c=r.apply(this,[o]);return k?(c.then(a,k),Promise.resolve()):c};A.setLocalDescription=i,i=function(o,a,k){let c=n.apply(this,[o]);return k?(c.then(a,k),Promise.resolve()):c},A.setRemoteDescription=i,i=function(o,a,k){let c=s.apply(this,[o]);return k?(c.then(a,k),Promise.resolve()):c},A.addIceCandidate=i}function me(e){let A=e&&e.navigator;if(A.mediaDevices&&A.mediaDevices.getUserMedia){let t=A.mediaDevices,j=t.getUserMedia.bind(t);A.mediaDevices.getUserMedia=r=>j(Zt(r))}!A.getUserMedia&&A.mediaDevices&&A.mediaDevices.getUserMedia&&(A.getUserMedia=function(j,r,n){A.mediaDevices.getUserMedia(j).then(r,n)}.bind(A))}function Zt(e){return e&&e.video!==void 0?Object.assign({},e,{video:te(e.video)}):e}function ge(e){if(!e.RTCPeerConnection)return;let A=e.RTCPeerConnection;e.RTCPeerConnection=function(j,r){if(j&&j.iceServers){let n=[];for(let s=0;s<j.iceServers.length;s++){let i=j.iceServers[s];i.urls===void 0&&i.url?(V("RTCIceServer.url","RTCIceServer.urls"),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,n.push(i)):n.push(j.iceServers[s])}j.iceServers=n}return new A(j,r)},e.RTCPeerConnection.prototype=A.prototype,"generateCertificate"in A&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get(){return A.generateCertificate}})}function xe(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ve(e){let A=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(j){if(j){typeof j.offerToReceiveAudio<"u"&&(j.offerToReceiveAudio=!!j.offerToReceiveAudio);let r=this.getTransceivers().find(s=>s.receiver.track.kind==="audio");j.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):j.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof j.offerToReceiveVideo<"u"&&(j.offerToReceiveVideo=!!j.offerToReceiveVideo);let n=this.getTransceivers().find(s=>s.receiver.track.kind==="video");j.offerToReceiveVideo===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):j.offerToReceiveVideo===!0&&!n&&this.addTransceiver("video",{direction:"recvonly"})}return A.apply(this,arguments)}}function Fe(e){typeof e!="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var be={};X(be,{removeExtmapAllowMixed:()=>bA,shimAddIceCandidateNullOrEmpty:()=>jA,shimConnectionState:()=>IA,shimMaxMessageSize:()=>eA,shimParameterlessSetLocalDescription:()=>rA,shimRTCIceCandidate:()=>AA,shimRTCIceCandidateRelayProtocol:()=>GA,shimSendThrowTypeError:()=>tA});var Q=Xe(Ie());function AA(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;let A=e.RTCIceCandidate;e.RTCIceCandidate=function(j){if(typeof j=="object"&&j.candidate&&j.candidate.indexOf("a=")===0&&(j=JSON.parse(JSON.stringify(j)),j.candidate=j.candidate.substring(2)),j.candidate&&j.candidate.length){let r=new A(j),n=Q.default.parseCandidate(j.candidate);for(let s in n)s in r||Object.defineProperty(r,s,{value:n[s]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new A(j)},e.RTCIceCandidate.prototype=A.prototype,y(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function GA(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||y(e,"icecandidate",A=>{if(A.candidate){let t=Q.default.parseCandidate(A.candidate.candidate);t.type==="relay"&&(A.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return A})}function eA(e,A){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});let t=function(i){if(!i||!i.sdp)return!1;let o=Q.default.splitSections(i.sdp);return o.shift(),o.some(a=>{let k=Q.default.parseMLine(a);return k&&k.kind==="application"&&k.protocol.indexOf("SCTP")!==-1})},j=function(i){let o=i.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(o===null||o.length<2)return-1;let a=parseInt(o[1],10);return a!==a?-1:a},r=function(i){let o=65536;return A.browser==="firefox"&&(A.version<57?i===-1?o=16384:o=2147483637:A.version<60?o=A.version===57?65535:65536:o=2147483637),o},n=function(i,o){let a=65536;A.browser==="firefox"&&A.version===57&&(a=65535);let k=Q.default.matchPrefix(i.sdp,"a=max-message-size:");return k.length>0?a=parseInt(k[0].substring(19),10):A.browser==="firefox"&&o!==-1&&(a=2147483637),a},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,A.browser==="chrome"&&A.version>=76){let{sdpSemantics:o}=this.getConfiguration();o==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){let o=j(arguments[0]),a=r(o),k=n(arguments[0],o),c;a===0&&k===0?c=Number.POSITIVE_INFINITY:a===0||k===0?c=Math.max(a,k):c=Math.min(a,k);let l={};Object.defineProperty(l,"maxMessageSize",{get(){return c}}),this._sctp=l}return s.apply(this,arguments)}}function tA(e){if(!(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype))return;function A(j,r){let n=j.send;j.send=function(){let i=arguments[0],o=i.length||i.size||i.byteLength;if(j.readyState==="open"&&r.sctp&&o>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return n.apply(j,arguments)}}let t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){let r=t.apply(this,arguments);return A(r,this),r},y(e,"datachannel",j=>(A(j.channel,j.target),j))}function IA(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;let A=e.RTCPeerConnection.prototype;Object.defineProperty(A,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(A,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{let j=A[t];A[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{let n=r.target;if(n._lastConnectionState!==n.connectionState){n._lastConnectionState=n.connectionState;let s=new Event("connectionstatechange",r);n.dispatchEvent(s)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),j.apply(this,arguments)}})}function bA(e,A){if(!e.RTCPeerConnection||A.browser==="chrome"&&A.version>=71||A.browser==="safari"&&A._safariVersion>=13.1)return;let t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let n=r.sdp.split(`
`).filter(s=>s.trim()!=="a=extmap-allow-mixed").join(`
`);e.RTCSessionDescription&&r instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:r.type,sdp:n}):r.sdp=n}return t.apply(this,arguments)}}function jA(e,A){if(!(e.RTCPeerConnection&&e.RTCPeerConnection.prototype))return;let t=e.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(A.browser==="chrome"&&A.version<78||A.browser==="firefox"&&A.version<68||A.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function rA(e,A){if(!(e.RTCPeerConnection&&e.RTCPeerConnection.prototype))return;let t=e.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(e.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return t.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?t.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(s=>t.apply(this,[s]))})}var Lr=Xe(Ie());function Yt({window:e}={},A={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){let t=fA,j=Ut(e),r={browserDetails:j,commonShim:be,extractVersion:N,disableLog:Vt,disableWarnings:Qt,sdp:Lr};switch(j.browser){case"chrome":if(!mA||!_A||!A.shimChrome)return t("Chrome shim is not included in this adapter release."),r;if(j.version===null)return t("Chrome shim can not determine version, not shimming."),r;t("adapter.js shimming chrome."),r.browserShim=mA,jA(e,j),rA(e,j),qA(e,j),re(e,j),_A(e,j),ne(e,j),oe(e,j),se(e,j),ie(e,j),ae(e,j),AA(e,j),GA(e,j),IA(e,j),eA(e,j),tA(e,j),bA(e,j);break;case"firefox":if(!vA||!xA||!A.shimFirefox)return t("Firefox shim is not included in this adapter release."),r;t("adapter.js shimming firefox."),r.browserShim=vA,jA(e,j),rA(e,j),gA(e,j),xA(e,j),ke(e,j),le(e,j),ce(e,j),Be(e,j),pe(e,j),Ee(e,j),he(e,j),de(e,j),ue(e,j),AA(e,j),IA(e,j),eA(e,j),tA(e,j);break;case"safari":if(!FA||!A.shimSafari)return t("Safari shim is not included in this adapter release."),r;t("adapter.js shimming safari."),r.browserShim=FA,jA(e,j),rA(e,j),ge(e,j),ve(e,j),_e(e,j),fe(e,j),qe(e,j),xe(e,j),me(e,j),Fe(e,j),AA(e,j),GA(e,j),eA(e,j),tA(e,j),bA(e,j);break;default:t("Unsupported browser!");break}return r}var Dr=Yt({window:typeof window>"u"?void 0:window}),ye=Dr;function M(e,A,t,j){Object.defineProperty(e,A,{get:t,set:j,enumerable:!0,configurable:!0})}var $A=class{constructor(){this.chunkedMTU=16300,this._dataCount=1,this.chunk=A=>{let t=[],j=A.byteLength,r=Math.ceil(j/this.chunkedMTU),n=0,s=0;for(;s<j;){let i=Math.min(j,s+this.chunkedMTU),o=A.slice(s,i),a={__peerData:this._dataCount,n,data:o,total:r};t.push(a),s=i,n++}return this._dataCount++,t}}};function Hr(e){let A=0;for(let r of e)A+=r.byteLength;let t=new Uint8Array(A),j=0;for(let r of e)t.set(r,j),j+=r.byteLength;return t}var $e=ye.default||ye,nA=new class{isWebRTCSupported(){return typeof RTCPeerConnection<"u"}isBrowserSupported(){let e=this.getBrowser(),A=this.getVersion();return this.supportedBrowsers.includes(e)?e==="chrome"?A>=this.minChromeVersion:e==="firefox"?A>=this.minFirefoxVersion:e==="safari"?!this.isIOS&&A>=this.minSafariVersion:!1:!1}getBrowser(){return $e.browserDetails.browser}getVersion(){return $e.browserDetails.version||0}isUnifiedPlanSupported(){let e=this.getBrowser(),A=$e.browserDetails.version||0;if(e==="chrome"&&A<this.minChromeVersion)return!1;if(e==="firefox"&&A>=this.minFirefoxVersion)return!0;if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let t,j=!1;try{t=new RTCPeerConnection,t.addTransceiver("audio"),j=!0}catch{}finally{t&&t.close()}return j}toString(){return`Supports:
    browser:${this.getBrowser()}
    version:${this.getVersion()}
    isIOS:${this.isIOS}
    isWebRTCSupported:${this.isWebRTCSupported()}
    isBrowserSupported:${this.isBrowserSupported()}
    isUnifiedPlanSupported:${this.isUnifiedPlanSupported()}`}constructor(){this.isIOS=typeof navigator<"u"?["iPad","iPhone","iPod"].includes(navigator.platform):!1,this.supportedBrowsers=["firefox","chrome","safari"],this.minFirefoxVersion=59,this.minChromeVersion=72,this.minSafariVersion=605}},Nr=e=>!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(e),ej=()=>Math.random().toString(36).slice(2),Aj={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:eu-0.turn.peerjs.com:3478","turn:us-0.turn.peerjs.com:3478"],username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},Pe=class extends $A{noop(){}blobToArrayBuffer(A,t){let j=new FileReader;return j.onload=function(r){r.target&&t(r.target.result)},j.readAsArrayBuffer(A),j}binaryStringToArrayBuffer(A){let t=new Uint8Array(A.length);for(let j=0;j<A.length;j++)t[j]=A.charCodeAt(j)&255;return t.buffer}isSecure(){return location.protocol==="https:"}constructor(...A){super(...A),this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedBrowsers={Chrome:1,chrome:1},this.defaultConfig=Aj,this.browser=nA.getBrowser(),this.browserVersion=nA.getVersion(),this.pack=Ae,this.unpack=YA,this.supports=function(){let t={browser:nA.isBrowserSupported(),webRTC:nA.isWebRTCSupported(),audioVideo:!1,data:!1,binaryBlob:!1,reliable:!1};if(!t.webRTC)return t;let j;try{j=new RTCPeerConnection(Aj),t.audioVideo=!0;let r;try{r=j.createDataChannel("_PEERJSTEST",{ordered:!0}),t.data=!0,t.reliable=!!r.ordered;try{r.binaryType="blob",t.binaryBlob=!nA.isIOS}catch{}}catch{}finally{r&&r.close()}}catch{}finally{j&&j.close()}return t}(),this.validateId=Nr,this.randomToken=ej}},I=new Pe,Vr="PeerJS: ";var Ke=class{get logLevel(){return this._logLevel}set logLevel(A){this._logLevel=A}log(...A){this._logLevel>=3&&this._print(3,...A)}warn(...A){this._logLevel>=2&&this._print(2,...A)}error(...A){this._logLevel>=1&&this._print(1,...A)}setLogFunction(A){this._print=A}_print(A,...t){let j=[Vr,...t];for(let r in j)j[r]instanceof Error&&(j[r]="("+j[r].name+") "+j[r].message);A>=3?console.log(...j):A>=2?console.warn("WARNING",...j):A>=1&&console.error("ERROR",...j)}constructor(){this._logLevel=0}},p=new Ke,ze={},Qr=Object.prototype.hasOwnProperty,G="~";function iA(){}Object.create&&(iA.prototype=Object.create(null),new iA().__proto__||(G=!1));function Ur(e,A,t){this.fn=e,this.context=A,this.once=t||!1}function tj(e,A,t,j,r){if(typeof t!="function")throw new TypeError("The listener must be a function");var n=new Ur(t,j||e,r),s=G?G+A:A;return e._events[s]?e._events[s].fn?e._events[s]=[e._events[s],n]:e._events[s].push(n):(e._events[s]=n,e._eventsCount++),e}function yA(e,A){--e._eventsCount===0?e._events=new iA:delete e._events[A]}function F(){this._events=new iA,this._eventsCount=0}F.prototype.eventNames=function(){var A=[],t,j;if(this._eventsCount===0)return A;for(j in t=this._events)Qr.call(t,j)&&A.push(G?j.slice(1):j);return Object.getOwnPropertySymbols?A.concat(Object.getOwnPropertySymbols(t)):A};F.prototype.listeners=function(A){var t=G?G+A:A,j=this._events[t];if(!j)return[];if(j.fn)return[j.fn];for(var r=0,n=j.length,s=new Array(n);r<n;r++)s[r]=j[r].fn;return s};F.prototype.listenerCount=function(A){var t=G?G+A:A,j=this._events[t];return j?j.fn?1:j.length:0};F.prototype.emit=function(A,t,j,r,n,s){var i=G?G+A:A;if(!this._events[i])return!1;var o=this._events[i],a=arguments.length,k,c;if(o.fn){switch(o.once&&this.removeListener(A,o.fn,void 0,!0),a){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,t),!0;case 3:return o.fn.call(o.context,t,j),!0;case 4:return o.fn.call(o.context,t,j,r),!0;case 5:return o.fn.call(o.context,t,j,r,n),!0;case 6:return o.fn.call(o.context,t,j,r,n,s),!0}for(c=1,k=new Array(a-1);c<a;c++)k[c-1]=arguments[c];o.fn.apply(o.context,k)}else{var l=o.length,d;for(c=0;c<l;c++)switch(o[c].once&&this.removeListener(A,o[c].fn,void 0,!0),a){case 1:o[c].fn.call(o[c].context);break;case 2:o[c].fn.call(o[c].context,t);break;case 3:o[c].fn.call(o[c].context,t,j);break;case 4:o[c].fn.call(o[c].context,t,j,r);break;default:if(!k)for(d=1,k=new Array(a-1);d<a;d++)k[d-1]=arguments[d];o[c].fn.apply(o[c].context,k)}}return!0};F.prototype.on=function(A,t,j){return tj(this,A,t,j,!1)};F.prototype.once=function(A,t,j){return tj(this,A,t,j,!0)};F.prototype.removeListener=function(A,t,j,r){var n=G?G+A:A;if(!this._events[n])return this;if(!t)return yA(this,n),this;var s=this._events[n];if(s.fn)s.fn===t&&(!r||s.once)&&(!j||s.context===j)&&yA(this,n);else{for(var i=0,o=[],a=s.length;i<a;i++)(s[i].fn!==t||r&&!s[i].once||j&&s[i].context!==j)&&o.push(s[i]);o.length?this._events[n]=o.length===1?o[0]:o:yA(this,n)}return this};F.prototype.removeAllListeners=function(A){var t;return A?(t=G?G+A:A,this._events[t]&&yA(this,t)):(this._events=new iA,this._eventsCount=0),this};F.prototype.off=F.prototype.removeListener;F.prototype.addListener=F.prototype.on;F.prefixed=G;F.EventEmitter=F;ze=F;var R={};M(R,"ConnectionType",()=>T);M(R,"PeerErrorType",()=>g);M(R,"BaseConnectionErrorType",()=>Ce);M(R,"DataConnectionErrorType",()=>Le);M(R,"SerializationType",()=>SA);M(R,"SocketEventType",()=>C);M(R,"ServerMessageType",()=>v);var T=function(e){return e.Data="data",e.Media="media",e}({}),g=function(e){return e.BrowserIncompatible="browser-incompatible",e.Disconnected="disconnected",e.InvalidID="invalid-id",e.InvalidKey="invalid-key",e.Network="network",e.PeerUnavailable="peer-unavailable",e.SslUnavailable="ssl-unavailable",e.ServerError="server-error",e.SocketError="socket-error",e.SocketClosed="socket-closed",e.UnavailableID="unavailable-id",e.WebRTC="webrtc",e}({}),Ce=function(e){return e.NegotiationFailed="negotiation-failed",e.ConnectionClosed="connection-closed",e}({}),Le=function(e){return e.NotOpenYet="not-open-yet",e.MessageToBig="message-too-big",e}({}),SA=function(e){return e.Binary="binary",e.BinaryUTF8="binary-utf8",e.JSON="json",e.None="raw",e}({}),C=function(e){return e.Message="message",e.Disconnected="disconnected",e.Error="error",e.Close="close",e}({}),v=function(e){return e.Heartbeat="HEARTBEAT",e.Candidate="CANDIDATE",e.Offer="OFFER",e.Answer="ANSWER",e.Open="OPEN",e.Error="ERROR",e.IdTaken="ID-TAKEN",e.InvalidKey="INVALID-KEY",e.Leave="LEAVE",e.Expire="EXPIRE",e}({}),jj="1.5.5",Te=class extends ze.EventEmitter{constructor(A,t,j,r,n,s=5e3){super(),this.pingInterval=s,this._disconnected=!0,this._messagesQueue=[];let i=A?"wss://":"ws://";this._baseUrl=i+t+":"+j+r+"peerjs?key="+n}start(A,t){this._id=A;let j=`${this._baseUrl}&id=${A}&token=${t}`;this._socket||!this._disconnected||(this._socket=new WebSocket(j+"&version="+jj),this._disconnected=!1,this._socket.onmessage=r=>{let n;try{n=JSON.parse(r.data),p.log("Server message received:",n)}catch{p.log("Invalid server message",r.data);return}this.emit(C.Message,n)},this._socket.onclose=r=>{this._disconnected||(p.log("Socket closed.",r),this._cleanup(),this._disconnected=!0,this.emit(C.Disconnected))},this._socket.onopen=()=>{this._disconnected||(this._sendQueuedMessages(),p.log("Socket open"),this._scheduleHeartbeat())})}_scheduleHeartbeat(){this._wsPingTimer=setTimeout(()=>{this._sendHeartbeat()},this.pingInterval)}_sendHeartbeat(){if(!this._wsOpen()){p.log("Cannot send heartbeat, because socket closed");return}let A=JSON.stringify({type:v.Heartbeat});this._socket.send(A),this._scheduleHeartbeat()}_wsOpen(){return!!this._socket&&this._socket.readyState===1}_sendQueuedMessages(){let A=[...this._messagesQueue];this._messagesQueue=[];for(let t of A)this.send(t)}send(A){if(this._disconnected)return;if(!this._id){this._messagesQueue.push(A);return}if(!A.type){this.emit(C.Error,"Invalid message");return}if(!this._wsOpen())return;let t=JSON.stringify(A);this._socket.send(t)}close(){this._disconnected||(this._cleanup(),this._disconnected=!0)}_cleanup(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)}},PA=class{constructor(A){this.connection=A}startConnection(A){let t=this._startPeerConnection();if(this.connection.peerConnection=t,this.connection.type===T.Media&&A._stream&&this._addTracksToConnection(A._stream,t),A.originator){let j=this.connection,r={ordered:!!A.reliable},n=t.createDataChannel(j.label,r);j._initializeDataChannel(n),this._makeOffer()}else this.handleSDP("OFFER",A.sdp)}_startPeerConnection(){p.log("Creating RTCPeerConnection.");let A=new RTCPeerConnection(this.connection.provider.options.config);return this._setupListeners(A),A}_setupListeners(A){let t=this.connection.peer,j=this.connection.connectionId,r=this.connection.type,n=this.connection.provider;p.log("Listening for ICE candidates."),A.onicecandidate=s=>{!s.candidate||!s.candidate.candidate||(p.log(`Received ICE candidates for ${t}:`,s.candidate),n.socket.send({type:v.Candidate,payload:{candidate:s.candidate,type:r,connectionId:j},dst:t}))},A.oniceconnectionstatechange=()=>{switch(A.iceConnectionState){case"failed":p.log("iceConnectionState is failed, closing connections to "+t),this.connection.emitError(Ce.NegotiationFailed,"Negotiation of connection to "+t+" failed."),this.connection.close();break;case"closed":p.log("iceConnectionState is closed, closing connections to "+t),this.connection.emitError(Ce.ConnectionClosed,"Connection to "+t+" closed."),this.connection.close();break;case"disconnected":p.log("iceConnectionState changed to disconnected on the connection with "+t);break;case"completed":A.onicecandidate=()=>{};break}this.connection.emit("iceStateChanged",A.iceConnectionState)},p.log("Listening for data channel"),A.ondatachannel=s=>{p.log("Received data channel");let i=s.channel;n.getConnection(t,j)._initializeDataChannel(i)},p.log("Listening for remote stream"),A.ontrack=s=>{p.log("Received remote stream");let i=s.streams[0],o=n.getConnection(t,j);if(o.type===T.Media){let a=o;this._addStreamToMediaConnection(i,a)}}}cleanup(){p.log("Cleaning up PeerConnection to "+this.connection.peer);let A=this.connection.peerConnection;if(!A)return;this.connection.peerConnection=null,A.onicecandidate=A.oniceconnectionstatechange=A.ondatachannel=A.ontrack=()=>{};let t=A.signalingState!=="closed",j=!1,r=this.connection.dataChannel;r&&(j=!!r.readyState&&r.readyState!=="closed"),(t||j)&&A.close()}async _makeOffer(){let A=this.connection.peerConnection,t=this.connection.provider;try{let j=await A.createOffer(this.connection.options.constraints);p.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(j.sdp=this.connection.options.sdpTransform(j.sdp)||j.sdp);try{await A.setLocalDescription(j),p.log("Set localDescription:",j,`for:${this.connection.peer}`);let r={sdp:j,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata};if(this.connection.type===T.Data){let n=this.connection;r={...r,label:n.label,reliable:n.reliable,serialization:n.serialization}}t.socket.send({type:v.Offer,payload:r,dst:this.connection.peer})}catch(r){r!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"&&(t.emitError(g.WebRTC,r),p.log("Failed to setLocalDescription, ",r))}}catch(j){t.emitError(g.WebRTC,j),p.log("Failed to createOffer, ",j)}}async _makeAnswer(){let A=this.connection.peerConnection,t=this.connection.provider;try{let j=await A.createAnswer();p.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(j.sdp=this.connection.options.sdpTransform(j.sdp)||j.sdp);try{await A.setLocalDescription(j),p.log("Set localDescription:",j,`for:${this.connection.peer}`),t.socket.send({type:v.Answer,payload:{sdp:j,type:this.connection.type,connectionId:this.connection.connectionId},dst:this.connection.peer})}catch(r){t.emitError(g.WebRTC,r),p.log("Failed to setLocalDescription, ",r)}}catch(j){t.emitError(g.WebRTC,j),p.log("Failed to create answer, ",j)}}async handleSDP(A,t){t=new RTCSessionDescription(t);let j=this.connection.peerConnection,r=this.connection.provider;p.log("Setting remote description",t);let n=this;try{await j.setRemoteDescription(t),p.log(`Set remoteDescription:${A} for:${this.connection.peer}`),A==="OFFER"&&await n._makeAnswer()}catch(s){r.emitError(g.WebRTC,s),p.log("Failed to setRemoteDescription, ",s)}}async handleCandidate(A){p.log("handleCandidate:",A);try{await this.connection.peerConnection.addIceCandidate(A),p.log(`Added ICE candidate for:${this.connection.peer}`)}catch(t){this.connection.provider.emitError(g.WebRTC,t),p.log("Failed to handleCandidate, ",t)}}_addTracksToConnection(A,t){if(p.log(`add tracks from stream ${A.id} to peer connection`),!t.addTrack)return p.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");A.getTracks().forEach(j=>{t.addTrack(j,A)})}_addStreamToMediaConnection(A,t){p.log(`add stream ${A.id} to media connection ${t.connectionId}`),t.addStream(A)}},KA=class extends ze.EventEmitter{emitError(A,t){p.error("Error:",t),this.emit("error",new Oe(`${A}`,t))}},Oe=class extends Error{constructor(A,t){typeof t=="string"?super(t):(super(),Object.assign(this,t)),this.type=A}},CA=class extends KA{get open(){return this._open}constructor(A,t,j){super(),this.peer=A,this.provider=t,this.options=j,this._open=!1,this.metadata=j.metadata}},TA=class e extends CA{static#A=this.ID_PREFIX="mc_";get type(){return T.Media}get localStream(){return this._localStream}get remoteStream(){return this._remoteStream}constructor(A,t,j){super(A,t,j),this._localStream=this.options._stream,this.connectionId=this.options.connectionId||e.ID_PREFIX+I.randomToken(),this._negotiator=new PA(this),this._localStream&&this._negotiator.startConnection({_stream:this._localStream,originator:!0})}_initializeDataChannel(A){this.dataChannel=A,this.dataChannel.onopen=()=>{p.log(`DC#${this.connectionId} dc connection success`),this.emit("willCloseOnRemote")},this.dataChannel.onclose=()=>{p.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}addStream(A){p.log("Receiving stream",A),this._remoteStream=A,super.emit("stream",A)}handleMessage(A){let t=A.type,j=A.payload;switch(A.type){case v.Answer:this._negotiator.handleSDP(t,j.sdp),this._open=!0;break;case v.Candidate:this._negotiator.handleCandidate(j.candidate);break;default:p.warn(`Unrecognized message type:${t} from peer:${this.peer}`);break}}answer(A,t={}){if(this._localStream){p.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}this._localStream=A,t&&t.sdpTransform&&(this.options.sdpTransform=t.sdpTransform),this._negotiator.startConnection({...this.options._payload,_stream:A});let j=this.provider._getMessages(this.connectionId);for(let r of j)this.handleMessage(r);this._open=!0}close(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,super.emit("close"))}},Se=class{constructor(A){this._options=A}_buildRequest(A){let t=this._options.secure?"https":"http",{host:j,port:r,path:n,key:s}=this._options,i=new URL(`${t}://${j}:${r}${n}${s}/${A}`);return i.searchParams.set("ts",`${Date.now()}${Math.random()}`),i.searchParams.set("version",jj),fetch(i.href,{referrerPolicy:this._options.referrerPolicy})}async retrieveId(){try{let A=await this._buildRequest("id");if(A.status!==200)throw new Error(`Error. Status:${A.status}`);return A.text()}catch(A){p.error("Error retrieving ID",A);let t="";throw this._options.path==="/"&&this._options.host!==I.CLOUD_HOST&&(t=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+t)}}async listAllPeers(){try{let A=await this._buildRequest("peers");if(A.status!==200){if(A.status===401){let t="";throw this._options.host===I.CLOUD_HOST?t="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":t="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+t)}throw new Error(`Error. Status:${A.status}`)}return A.json()}catch(A){throw p.error("Error retrieving list peers",A),new Error("Could not get list peers from the server."+A)}}},OA=class e extends CA{static#A=this.ID_PREFIX="dc_";static#e=this.MAX_BUFFERED_AMOUNT=8388608;get type(){return T.Data}constructor(A,t,j){super(A,t,j),this.connectionId=this.options.connectionId||e.ID_PREFIX+ej(),this.label=this.options.label||this.connectionId,this.reliable=!!this.options.reliable,this._negotiator=new PA(this),this._negotiator.startConnection(this.options._payload||{originator:!0,reliable:this.reliable})}_initializeDataChannel(A){this.dataChannel=A,this.dataChannel.onopen=()=>{p.log(`DC#${this.connectionId} dc connection success`),this._open=!0,this.emit("open")},this.dataChannel.onmessage=t=>{p.log(`DC#${this.connectionId} dc onmessage:`,t.data)},this.dataChannel.onclose=()=>{p.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}close(A){if(A?.flush){this.send({__peerData:{type:"close"}});return}this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this.dataChannel=null),this.open&&(this._open=!1,super.emit("close"))}send(A,t=!1){if(!this.open){this.emitError(Le.NotOpenYet,"Connection is not open. You should listen for the `open` event before sending messages.");return}return this._send(A,t)}async handleMessage(A){let t=A.payload;switch(A.type){case v.Answer:await this._negotiator.handleSDP(A.type,t.sdp);break;case v.Candidate:await this._negotiator.handleCandidate(t.candidate);break;default:p.warn("Unrecognized message type:",A.type,"from peer:",this.peer);break}}},oA=class extends OA{get bufferSize(){return this._bufferSize}_initializeDataChannel(A){super._initializeDataChannel(A),this.dataChannel.binaryType="arraybuffer",this.dataChannel.addEventListener("message",t=>this._handleDataMessage(t))}_bufferedSend(A){(this._buffering||!this._trySend(A))&&(this._buffer.push(A),this._bufferSize=this._buffer.length)}_trySend(A){if(!this.open)return!1;if(this.dataChannel.bufferedAmount>OA.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(()=>{this._buffering=!1,this._tryBuffer()},50),!1;try{this.dataChannel.send(A)}catch(t){return p.error(`DC#:${this.connectionId} Error when sending:`,t),this._buffering=!0,this.close(),!1}return!0}_tryBuffer(){if(!this.open||this._buffer.length===0)return;let A=this._buffer[0];this._trySend(A)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}close(A){if(A?.flush){this.send({__peerData:{type:"close"}});return}this._buffer=[],this._bufferSize=0,super.close()}constructor(...A){super(...A),this._buffer=[],this._bufferSize=0,this._buffering=!1}},sA=class extends oA{close(A){super.close(A),this._chunkedData={}}constructor(A,t,j){super(A,t,j),this.chunker=new $A,this.serialization=SA.Binary,this._chunkedData={}}_handleDataMessage({data:A}){let t=YA(A),j=t.__peerData;if(j){if(j.type==="close"){this.close();return}this._handleChunk(t);return}this.emit("data",t)}_handleChunk(A){let t=A.__peerData,j=this._chunkedData[t]||{data:[],count:0,total:A.total};if(j.data[A.n]=new Uint8Array(A.data),j.count++,this._chunkedData[t]=j,j.total===j.count){delete this._chunkedData[t];let r=Hr(j.data);this._handleDataMessage({data:r})}}_send(A,t){let j=Ae(A);if(j instanceof Promise)return this._send_blob(j);if(!t&&j.byteLength>this.chunker.chunkedMTU){this._sendChunks(j);return}this._bufferedSend(j)}async _send_blob(A){let t=await A;if(t.byteLength>this.chunker.chunkedMTU){this._sendChunks(t);return}this._bufferedSend(t)}_sendChunks(A){let t=this.chunker.chunk(A);p.log(`DC#${this.connectionId} Try to send ${t.length} chunks...`);for(let j of t)this.send(j,!0)}},Me=class extends oA{_handleDataMessage({data:A}){super.emit("data",A)}_send(A,t){this._bufferedSend(A)}constructor(...A){super(...A),this.serialization=SA.None}},Re=class extends oA{_handleDataMessage({data:A}){let t=this.parse(this.decoder.decode(A)),j=t.__peerData;if(j&&j.type==="close"){this.close();return}this.emit("data",t)}_send(A,t){let j=this.encoder.encode(this.stringify(A));if(j.byteLength>=I.chunkedMTU){this.emitError(Le.MessageToBig,"Message too big for JSON channel");return}this._bufferedSend(j)}constructor(...A){super(...A),this.serialization=SA.JSON,this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.stringify=JSON.stringify,this.parse=JSON.parse}};var we=class e extends KA{static#A=this.DEFAULT_KEY="peerjs";get id(){return this._id}get options(){return this._options}get open(){return this._open}get socket(){return this._socket}get connections(){let A=Object.create(null);for(let[t,j]of this._connections)A[t]=j;return A}get destroyed(){return this._destroyed}get disconnected(){return this._disconnected}constructor(A,t){super(),this._serializers={raw:Me,json:Re,binary:sA,"binary-utf8":sA,default:sA},this._id=null,this._lastServerId=null,this._destroyed=!1,this._disconnected=!1,this._open=!1,this._connections=new Map,this._lostMessages=new Map;let j;if(A&&A.constructor==Object?t=A:A&&(j=A.toString()),t={debug:0,host:I.CLOUD_HOST,port:I.CLOUD_PORT,path:"/",key:e.DEFAULT_KEY,token:I.randomToken(),config:I.defaultConfig,referrerPolicy:"strict-origin-when-cross-origin",serializers:{},...t},this._options=t,this._serializers={...this._serializers,...this.options.serializers},this._options.host==="/"&&(this._options.host=window.location.hostname),this._options.path&&(this._options.path[0]!=="/"&&(this._options.path="/"+this._options.path),this._options.path[this._options.path.length-1]!=="/"&&(this._options.path+="/")),this._options.secure===void 0&&this._options.host!==I.CLOUD_HOST?this._options.secure=I.isSecure():this._options.host==I.CLOUD_HOST&&(this._options.secure=!0),this._options.logFunction&&p.setLogFunction(this._options.logFunction),p.logLevel=this._options.debug||0,this._api=new Se(t),this._socket=this._createServerConnection(),!I.supports.audioVideo&&!I.supports.data){this._delayedAbort(g.BrowserIncompatible,"The current browser does not support WebRTC");return}if(j&&!I.validateId(j)){this._delayedAbort(g.InvalidID,`ID "${j}" is invalid`);return}j?this._initialize(j):this._api.retrieveId().then(r=>this._initialize(r)).catch(r=>this._abort(g.ServerError,r))}_createServerConnection(){let A=new Te(this._options.secure,this._options.host,this._options.port,this._options.path,this._options.key,this._options.pingInterval);return A.on(C.Message,t=>{this._handleMessage(t)}),A.on(C.Error,t=>{this._abort(g.SocketError,t)}),A.on(C.Disconnected,()=>{this.disconnected||(this.emitError(g.Network,"Lost connection to server."),this.disconnect())}),A.on(C.Close,()=>{this.disconnected||this._abort(g.SocketClosed,"Underlying socket is already closed.")}),A}_initialize(A){this._id=A,this.socket.start(A,this._options.token)}_handleMessage(A){let t=A.type,j=A.payload,r=A.src;switch(t){case v.Open:this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case v.Error:this._abort(g.ServerError,j.msg);break;case v.IdTaken:this._abort(g.UnavailableID,`ID "${this.id}" is taken`);break;case v.InvalidKey:this._abort(g.InvalidKey,`API KEY "${this._options.key}" is invalid`);break;case v.Leave:p.log(`Received leave message from ${r}`),this._cleanupPeer(r),this._connections.delete(r);break;case v.Expire:this.emitError(g.PeerUnavailable,`Could not connect to peer ${r}`);break;case v.Offer:{let n=j.connectionId,s=this.getConnection(r,n);if(s&&(s.close(),p.warn(`Offer received for existing Connection ID:${n}`)),j.type===T.Media){let o=new TA(r,this,{connectionId:n,_payload:j,metadata:j.metadata});s=o,this._addConnection(r,s),this.emit("call",o)}else if(j.type===T.Data){let o=new this._serializers[j.serialization](r,this,{connectionId:n,_payload:j,metadata:j.metadata,label:j.label,serialization:j.serialization,reliable:j.reliable});s=o,this._addConnection(r,s),this.emit("connection",o)}else{p.warn(`Received malformed connection type:${j.type}`);return}let i=this._getMessages(n);for(let o of i)s.handleMessage(o);break}default:{if(!j){p.warn(`You received a malformed message from ${r} of type ${t}`);return}let n=j.connectionId,s=this.getConnection(r,n);s&&s.peerConnection?s.handleMessage(A):n?this._storeMessage(n,A):p.warn("You received an unrecognized message:",A);break}}}_storeMessage(A,t){this._lostMessages.has(A)||this._lostMessages.set(A,[]),this._lostMessages.get(A).push(t)}_getMessages(A){let t=this._lostMessages.get(A);return t?(this._lostMessages.delete(A),t):[]}connect(A,t={}){if(t={serialization:"default",...t},this.disconnected){p.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError(g.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}let j=new this._serializers[t.serialization](A,this,t);return this._addConnection(A,j),j}call(A,t,j={}){if(this.disconnected){p.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError(g.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}if(!t){p.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}let r=new TA(A,this,{...j,_stream:t});return this._addConnection(A,r),r}_addConnection(A,t){p.log(`add connection ${t.type}:${t.connectionId} to peerId:${A}`),this._connections.has(A)||this._connections.set(A,[]),this._connections.get(A).push(t)}_removeConnection(A){let t=this._connections.get(A.peer);if(t){let j=t.indexOf(A);j!==-1&&t.splice(j,1)}this._lostMessages.delete(A.connectionId)}getConnection(A,t){let j=this._connections.get(A);if(!j)return null;for(let r of j)if(r.connectionId===t)return r;return null}_delayedAbort(A,t){setTimeout(()=>{this._abort(A,t)},0)}_abort(A,t){p.error("Aborting!"),this.emitError(A,t),this._lastServerId?this.disconnect():this.destroy()}destroy(){this.destroyed||(p.log(`Destroy peer with ID:${this.id}`),this.disconnect(),this._cleanup(),this._destroyed=!0,this.emit("close"))}_cleanup(){for(let A of this._connections.keys())this._cleanupPeer(A),this._connections.delete(A);this.socket.removeAllListeners()}_cleanupPeer(A){let t=this._connections.get(A);if(t)for(let j of t)j.close()}disconnect(){if(this.disconnected)return;let A=this.id;p.log(`Disconnect peer with ID:${A}`),this._disconnected=!0,this._open=!1,this.socket.close(),this._lastServerId=A,this._id=null,this.emit("disconnected",A)}reconnect(){if(this.disconnected&&!this.destroyed)p.log(`Attempting reconnection to server with ID ${this._lastServerId}`),this._disconnected=!1,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(!this.disconnected&&!this.open)p.error("In a hurry? We're still trying to make the initial connection!");else throw new Error(`Peer ${this.id} cannot reconnect because it is not disconnected from the server!`)}}listAllPeers(A=t=>{}){this._api.listAllPeers().then(t=>A(t)).catch(t=>this._abort(g.ServerError,t))}};var rj=we;var MA=class{peerConnectionStatus="Waiting";serverConnection;peerjs;p2pConnection=null;role;clientId;serverStreamController=null;serverStream;peerStreamController=null;peerStream;constructor(){this.serverStream=new ReadableStream({start:A=>{this.serverStreamController=A}}),this.peerStream=new ReadableStream({start:A=>{this.peerStreamController=A}})}async connect(){this.serverConnection=new WebSocket("wss://flashes-server-d5z5.shuttle.app/ws");let A={type:"ClientJoined"};return new Promise((t,j)=>{this.serverConnection.onopen=()=>{this.serverConnection.send(JSON.stringify(A)),t()},this.serverConnection.onmessage=async r=>{let n=JSON.parse(r.data);switch(this.serverStreamController&&this.serverStreamController.enqueue({...n}),n.type){case"ClientAcknowledged":this.clientId=n.clientId,this.role=n.role;break;case"PeerJoined":this.role==="Player"&&(this.peerConnectionStatus="Connected"),await this.initializePeerConnection(n.peerId);break}},this.serverConnection.onerror=r=>{console.error("WebSocket error:",r),j(r)},this.serverConnection.onclose=()=>{this.serverStreamController&&this.serverStreamController.close()}})}closeServerConnection(){this.serverStreamController?.close(),this.serverStream.cancel(),this.serverStreamController=null}async initializePeerConnection(A){if(!this.clientId)throw new Error("No clientId exists, cannot proceed");this.peerjs=new rj(this.clientId,{config:{iceServers:[{urls:"stun:stun.relay.metered.ca:80"}]}}),this.peerjs.on("open",()=>{this.peerjs&&this.role==="Player"&&A&&(this.p2pConnection=this.peerjs.connect(A),this.setupDataConnectionEventHandlers(this.p2pConnection)),this.peerConnectionStatus="Waiting"}),this.peerjs.on("connection",t=>{this.role==="Spectator"&&(this.p2pConnection=t,this.setupDataConnectionEventHandlers(t))})}setupDataConnectionEventHandlers(A){A.on("open",()=>{}),A.on("data",t=>{this.peerStreamController&&(this.peerConnectionStatus="Connected",this.peerStreamController.enqueue({...t}))}),A.on("close",()=>{this.peerConnectionStatus="Disconnected",this.p2pConnection=null}),A.on("error",t=>{console.error("P2P connection error:",t),this.peerConnectionStatus="Disconnected",this.p2pConnection=null})}sendToPeer(A){this.p2pConnection?.open&&this.p2pConnection.send(A)}};var $={ANNOUNCEMENT:"announcement",MAP:"map"},aA=(e,A)=>{A?localStorage.setItem(e,A):localStorage.removeItem(e)},w=e=>localStorage.getItem(e);var P={Opening:"opening",Surroundings:"surroundings",None:"none"},De=[P.Opening,P.Surroundings,P.None],RA=()=>w($.ANNOUNCEMENT),Jr=e=>{aA($.ANNOUNCEMENT,e)},nj=()=>{RA()||Jr(P.Opening)},He=()=>{let e=w($.ANNOUNCEMENT),A=De.findIndex(r=>r===e)||0,t=Math.min(A+1,De.length-1),j=De[t];aA($.ANNOUNCEMENT,j||P.None)},Ne=e=>{let A=!1,t=0,j=!1,r=0;return{getNextSentence:()=>(r=0,t=j?Math.min(t+1,e.length-1):t,A?j=!j:A=!0,{isDone:t===e.length-1}),getStreamingSentence:()=>{let i=e[t]||"";return r=j?i.length:Math.min(r+1,i.length),j=r>=i.length-1,{content:i.slice(0,r),isSentenceComplete:j}}}};var Ve=["X","_","T","*",".","P","G","g"];var sj={X:{displayGlyph:"+",cellColor:{hue:251,saturation:20,luminosity:67,alpha:80},cellBackground:{hue:0,saturation:0,luminosity:85,alpha:100}},_:{displayGlyph:" ",cellColor:{hue:211,saturation:76,luminosity:67,alpha:0},cellBackground:{hue:211,saturation:76,luminosity:67,alpha:100}},T:{displayGlyph:"\u2663",cellColor:{hue:0,saturation:0,luminosity:0,alpha:100},cellBackground:{hue:0,saturation:0,luminosity:38,alpha:100}},"*":{displayGlyph:" ",cellColor:{hue:0,saturation:0,luminosity:59,alpha:100},cellBackground:{hue:0,saturation:0,luminosity:59,alpha:100}},".":{displayGlyph:".",cellColor:{hue:0,saturation:0,luminosity:55,alpha:0},cellBackground:{hue:0,saturation:0,luminosity:55,alpha:100}},P:{displayGlyph:"@",cellColor:{hue:44,saturation:96,luminosity:45,alpha:100},cellBackground:{hue:0,saturation:0,luminosity:55,alpha:100}},G:{displayGlyph:"G",cellColor:{hue:166,saturation:45,luminosity:49,alpha:80},cellBackground:{hue:0,saturation:0,luminosity:55,alpha:100}},g:{displayGlyph:"g",cellColor:{hue:0,saturation:0,luminosity:55,alpha:100},cellBackground:{hue:0,saturation:0,luminosity:55,alpha:100}}},ij=["."],oj="P",aj="G",kj="g";var Qe={Off:"\u2727",On:"\u2726"};var kA=40,cA=12,m={TraumaL:"traumaL",TraumaR:"traumaR",TraumaU:"traumaU",TraumaD:"traumaD",None:"None"},BA={Drama:"zoomRotate",None:"None"},cj=[m.TraumaL,m.TraumaR,m.TraumaU,m.TraumaD],K={PlayerMoveL:"moveL",PlayerMoveR:"moveR",PlayerMoveU:"moveU",PlayerMoveD:"moveD",None:"None"},Bj=["ArrowUp","ArrowLeft","ArrowDown","ArrowRight","w","a","s","d"],lA={ArrowUp:[0,-1],ArrowLeft:[-1,0],ArrowDown:[0,1],ArrowRight:[1,0],w:[0,-1],a:[-1,0],s:[0,1],d:[1,0]},lj=["You wake up from what seems like a daze","Your ribs hurt if you take a deep breath","The assistance system is unresponsive. You tap the headlamp (\u2727), nothing","You tap it a few more times, it flickers to life.",""],pj=["The dark clouds shift overhead, you can barely see through the thick canopy","You wonder how long the batteries will last..",""];var Xr=e=>A=>A.key===e,Ej=e=>{let A=(...t)=>t.length>=e.length?e(...t):(...j)=>A(...t,...j);return A},hj=(...e)=>e.reduce((A,t)=>j=>A(t(j))),dj=(e,A=300)=>{let t=0,j;return()=>++t>=e?(t=0,window.clearTimeout(j),!0):(j&&window.clearTimeout(j),j=window.setTimeout(()=>{t=0},A),!1)};var Ue=()=>{let e=null;return A=>{let t=e!==A;return e=A,t}};var Wr=Ej((e,{grid1DArray:A,width:t})=>{let j=[];for(let r=0;r<A.length;r+=t){let n=A.slice(r,r+t),s=(e%t+t)%t;j.push(...n.slice(s),...n.slice(0,s))}return{grid1DArray:j,width:t}}),uj=Ej((e,{grid1DArray:A,width:t})=>{let j=A.length/t,r=(e%j+j)%j,n=[];for(let i=0;i<A.length;i+=t)n.push(A.slice(i,i+t));return{grid1DArray:n.slice(r).concat(n.slice(0,r)).flat(),width:t}}),pA=(e,A)=>({x:e%A,y:Math.floor(e/A)}),fj=Wr(1),qj=uj(1),Rn=uj(-1),_j=e=>Bj.includes(e.key),wA=Xr("f");var zA=(e,A,t)=>{if(e<0)throw new Error("Invalid cellIdx");let{x:j,y:r}=pA(A,t),n=pA(e,t);return[n.x-j,n.y-r]};var Zr=16,Yr={Intro:"intro",None:"none"},LA=[{id:1,content:"*.........*....*.........*TT*....*.......*TTTT*.*..*......*TT*.......***...**..**...*TTT**.....**T.*TTTT**........T.*T**....**.......**....*T*.**T........*TTT*.TT....*TT*.*TT*........*TT*...........T.*T*........*T*.............*TTT*.............**.........",width:Zr}],mj=[{id:1,content:".......*...............*.*...*...............*.....*..................*..*................*.......*........*.....*.........*....*....*....*.....",width:cA}],An=()=>w($.MAP),en=e=>{aA($.MAP,e)},gj=()=>{An()||en(Yr.Intro)};var tn=(e,A)=>hj(fj,qj)({grid1DArray:e,width:A}),jn=Object.values(lA),U=[],DA=class{rafTimer;mapBuffer;mapWidth;viewWidth;playerCellIdx;visibilityState;cameraAnimationState={shake:m.None,move:BA.None};playerAnimationState={isDead:!1,move:K.None,trauma:m.None,hop:!1};weatherState;particleState=[null,null];gridContainer=document.getElementById("grid-container");maskContainer=document.getElementById("mask-container");gameContainer=document.getElementById("game-container");particleContainer=document.getElementById("particles");overlayContainer=document.getElementById("overlay-container");init(){this.rafTimer&&(cancelIdleCallback(this.rafTimer),this.rafTimer=void 0),this.render()}updateRendererState({gameMap:A,visibilityState:t,playerCellIdx:j,particleState:r,playerAnimationState:n}){this.mapBuffer=A.level,this.mapWidth=A.width,this.viewWidth=A.viewWidth,this.playerCellIdx=j,this.visibilityState=t,this.particleState=[...r],this.playerAnimationState={...n}}async render(){if(!this.mapBuffer||!this.visibilityState||!this.mapWidth||!this.viewWidth||!this.playerCellIdx)throw new Error("Renderer not initialized properly");let A=Array.from(this.visibilityState).map(o=>1/(2+o)),t=LA[0];U=U.length>0?[...U]:[...t.content.split("").map(o=>Ve.findIndex(a=>a===o))],U=[...tn(U,this.mapWidth).grid1DArray],this.maskContainer.innerHTML="",this.mapBuffer.forEach((o,a)=>{let k=document.createElement("div");k.classList.add("pointer-none","cell","bg-black");let c=A[a];k.style.opacity=`${1-Math.min(1,Math.floor(c/.01))-.05}`,this.maskContainer.appendChild(k)}),this.gridContainer.innerHTML="",this.gridContainer.style.gridTemplateColumns=`repeat(${this.viewWidth}, minmax(0px, 1fr))`,this.overlayContainer.style.gridTemplateColumns=`repeat(${this.viewWidth}, minmax(0px, 1fr))`,this.maskContainer.style.gridTemplateColumns=`repeat(${this.viewWidth}, minmax(0px, 1fr))`;let j=document.createDocumentFragment(),{renderParticleGlyph:r,setParticleRenderAnchor:n}=this.getParticleRenderer(),{renderParticleGlyph:s,setParticleRenderAnchor:i}=this.getParticleRenderer();this.mapBuffer.forEach((o,a)=>{let k=zA(a,this.playerCellIdx||0,this.mapWidth||16),c=Ve[o];if(!c)return;let{displayGlyph:l,cellBackground:d,cellColor:q}=sj[c],f=document.createElement("div"),J=A[a],EA=U[a];if(!(!J||!EA)){if(f.textContent=l,f.style.backgroundColor=`        hsla(        ${d.hue},        ${d.saturation}%,        ${Math.max(4,(J+EA/200)*100)}%,        ${d.alpha}%)`,f.style.color=`          hsla(          ${q.hue},          ${q.saturation}%,          ${q.luminosity}%,          ${q.alpha}%)`,f.classList.add("pointer-none","cell","base","relative"),(c===kj||c===aj)&&i(f),c===oj){f.style.color=`          hsla(          ${q.hue},          ${q.saturation}%,          ${q.luminosity}%,          ${q.alpha}%)`;let b=document.createElement("span");f.textContent="",b.textContent=l,b.classList.add("glyph"),this.playerAnimationState.trauma!==m.None&&b.classList.add(this.playerAnimationState.trauma),this.playerAnimationState.move!==m.None&&b.classList.add(this.playerAnimationState.move),this.playerAnimationState.hop&&b.classList.add("hop"),f.appendChild(b),n(f)}k&&jn.some(b=>b[0]===k[0]&&b[1]===k[1])&&f.classList.remove("pointer-none"),ij.includes(l)&&f.classList.add("text-transparent"),f.dataset.idx=`${a}`,j.appendChild(f)}}),this.gridContainer.appendChild(j),this.particleState[0]&&r(`${this.particleState[0]}`),this.particleState[1]&&s(`${this.particleState[1]}`),this.cameraAnimationState.shake!==m.None&&(this.gameContainer.classList.add(this.cameraAnimationState.shake),_.fromTimer(100).subscribe({next:()=>{this.gameContainer.classList.remove(...cj)},complete:()=>{}}))}getParticleRenderer=()=>{let A,t=document.createElement("span");return t.classList.add("absolute","color-warning","hidden"),this.particleContainer.appendChild(t),{renderParticleGlyph:j=>{let r=A.getBoundingClientRect(),n=r.height===kA?r.height/4:0;t.textContent=j,t.style.left=`${r.left+n}px`,t.style.top=`${r.top-r.height/2}px`,t.classList.add("floatFade"),t.classList.remove("hidden"),_.fromTimer(200).subscribe({next:()=>{t.classList.remove("floatFade"),t.classList.add("hidden")},complete:()=>{}})},setParticleRenderAnchor:j=>{A=j}}}};nj();gj();var Je=class e{connectionManager;role="Spectator";map;flashlight;renderer=new DA;gameState={isGameOver:!1};monsterState={poise:120};cameraState={shake:m.None,move:BA.None};playerState={poise:100,move:K.None,trauma:m.None,isFlashlightOn:w($.ANNOUNCEMENT)===P.None,hop:!1};uiState={isInitialized:!1,showUI:!0,roleTab:document.getElementById("role-tab"),playableContainer:document.getElementById("playable-container"),playButtonContainer:document.getElementById("play-button-container"),playButtonEl:document.getElementById("play-button"),buttonsContainer:document.getElementById("buttons-container"),restartContainer:document.getElementById("restart-container"),flashlightButtonEl:document.getElementById("flashlight"),particleContainer:document.getElementById("particles"),gameContainer:document.getElementById("game-container"),gridContainer:document.getElementById("grid-container"),overlayContainer:document.getElementById("overlay-container"),maskContainer:document.getElementById("mask-container"),dPad:document.getElementById("d-pad"),announcementTarget:document.getElementById("announcement")};weather=LA[0];rain=mj[0];pendingInitialStateVector=null;constructor(A){this.connectionManager=A}static async init(){let A=new MA;await A.connect();let t=new e(A);return t.setupEventHandlers(),_.eagerFromReadableStream(t.connectionManager.serverStream).subscribe({next:async({value:j})=>{switch(t.updateConnectionStatusUI(),j.type){case"ClientAcknowledged":{t.role=j.role,t.map=j.map;break}case"PeerJoined":{t.connectionManager.closeServerConnection();break}default:console.warn("Unexpected message type")}},complete:()=>{}}),_.eagerFromReadableStream(t.connectionManager.peerStream).subscribe({next:async({value:j})=>{switch(t.updateConnectionStatusUI(),j.type){case"InitialStateVector":{if(t.role==="Player")break;t.pendingInitialStateVector=j.data;break}case"Delta":{t.flashlight?.apply_delta_js(new Uint8Array(j.data)),t.tick();break}default:console.warn("Unexpected message type")}},complete:()=>{}}),t}async sendDelta(A){this.connectionManager.sendToPeer({type:"Delta",data:A})}async sendInitialStateVector(A){this.role!=="Spectator"&&this.connectionManager.sendToPeer({type:"InitialStateVector",data:A})}async startGame(){if(!this.map)return;let{level:A,width:t,viewWidth:j,cellWidth:r}=this.map;this.flashlight=uA.new_from_js(new Uint8Array(A),t,r,j),this.pendingInitialStateVector&&this.role==="Spectator"&&(this.flashlight.apply_initial_state_vector_js(new Uint8Array(this.pendingInitialStateVector)),this.pendingInitialStateVector=null),this.initRain(),this.initializeUI(),await this.tick()}updateConnectionStatusUI(){switch(this.connectionManager.peerConnectionStatus){case"Waiting":this.uiState.playButtonEl.textContent="wait for P2...";break;case"Connected":this.uiState.playButtonEl.textContent="Play",this.uiState.playButtonEl.classList.remove("pointer-none");break;case"Disconnected":this.uiState.playButtonEl.textContent="Disconnected";break}}setupEventHandlers(){_.fromEvent("click",this.uiState.playButtonEl).subscribe({next:()=>{this.startGame(),this.uiState.playButtonContainer.classList.add("opacity-0")},complete:()=>{}});let t=_.fromEvent("keyup",document.body),j=_.fromEvent("keydown",document.body),r=_.fromEvent("click",this.uiState.dPad),n=_.fromEvent("click",this.uiState.gridContainer),s=_.fromEvent("click",this.uiState.flashlightButtonEl),i=_.fromInterval(1e4),o=j.filter(u=>_j(u)),a=t.filter(u=>wA(u));o.filter(()=>this.role!=="Spectator").map(u=>{u.preventDefault();let x=lA[u.key];if(!x)throw new Error("Failed to find move delta");return{delta:x}}).subscribe({next:this.moveWithDelta,complete:()=>{}}),r.filter(()=>this.role!=="Spectator").map(u=>{u.preventDefault();let x=u.target.getAttribute("aria-label");if(!x)throw new Error("No aria label found");return{delta:lA[x]}}).subscribe({next:this.moveWithDelta,complete:()=>{}}),n.filter(()=>this.role!=="Spectator").filter(u=>u.target.classList.contains("cell")).map(u=>{u.preventDefault();let O=u.target.dataset.idx;if(!O)throw new Error("Failed to find cell idx");return{cellIdx:Number.parseInt(O)}}).subscribe({next:this.selectCell,complete:()=>{}});let{getNextSentence:k,getStreamingSentence:c}=Ne(lj),{getNextSentence:l,getStreamingSentence:d}=Ne(pj),q=_.fromEvent("keyup",document.body).filter(u=>!wA(u)),f=_.fromEvent("click",document.body),J=q.withLatestFrom(f).filter(()=>RA()===P.Opening&&!this.playerState.isFlashlightOn).switchMap(()=>{let{isDone:u}=k();return _.fromInterval(60).map(()=>{let{content:x,isSentenceComplete:O}=c();return{content:x,isDone:u&&O}})}).filter(({content:u})=>Ue()(u)).subscribe({next:({isDone:u,content:x})=>{this.uiState.announcementTarget.classList.add("opacity-transition-fast"),this.uiState.announcementTarget.classList.remove("opacity-0","opacity-transition-faster"),this.uiState.announcementTarget.textContent=x,u&&(this.uiState.announcementTarget.classList.add("opacity-0","opacity-transition-faster"),J(),He())},complete:()=>{}}),EA=_.fromEvent("keyup",document.body).filter(u=>!wA(u)),b=_.fromEvent("click",document.body),xj=EA.withLatestFrom(b).filter(()=>RA()===P.Surroundings&&this.playerState.isFlashlightOn).switchMap(()=>{let{isDone:u}=l();return _.fromInterval(60).map(()=>{let{content:x,isSentenceComplete:O}=d();return{content:x,isDone:u&&O}})}).filter(({content:u})=>Ue()(u)).subscribe({next:({isDone:u,content:x})=>{this.uiState.announcementTarget.classList.add("opacity-transition-fast"),this.uiState.announcementTarget.classList.remove("opacity-0","opacity-transition-faster"),this.uiState.announcementTarget.textContent=x,u&&(this.uiState.announcementTarget.classList.add("opacity-0"),xj(),He())},complete:()=>{}}),vj=s.withLatestFrom(a).filter(dj(3)).filter(()=>!this.playerState.isFlashlightOn).map(([u,x])=>(u?.preventDefault(),x?.preventDefault(),{value:this.playerState.isFlashlightOn})).subscribe({next:async({value:u})=>{await this.toggleFlashlight({value:u}),vj(),J()},complete:()=>{}});i.subscribe({next:u=>{u%4?this.uiState.overlayContainer.classList.add("fadeIn","opacity-transition"):this.uiState.overlayContainer.classList.remove("fadeIn")},complete:()=>{}})}initializeUI(){if(!this.map||this.uiState.isInitialized)return;this.role==="Spectator"&&(this.uiState.buttonsContainer.classList.add("opacity-0"),this.uiState.roleTab.classList.remove("opacity-0")),this.uiState.playableContainer.style.width=`${kA*(this.map.viewWidth||cA)}`,this.uiState.gridContainer.style.width=`${kA*(this.map.viewWidth||cA)}`,this.uiState.gridContainer.style.gridTemplateColumns=`repeat(${this.map.width}, minmax(0, 1fr))`,this.uiState.overlayContainer.style.gridTemplateColumns=`repeat(${this.rain.width}, minmax(0, 1fr))`,this.uiState.maskContainer.style.gridTemplateColumns=`repeat(${this.map.width}, minmax(0, 1fr))`;let t=this.rain.content.split("").map(j=>j==="*"?".":" ");for(let j of t){let r=document.createElement("div");r.textContent=j,r.classList.add("invert","cell","pointer-none"),this.uiState.overlayContainer.appendChild(r)}this.initRain(),this.uiState.isInitialized=!0}get engine(){if(!this.flashlight)throw new Error("Game not initialized");return this.flashlight}get mapWidth(){if(!this.map)throw new Error("Game not initialized");return this.map.width}setGameOver(){this.gameState.isGameOver&&(this.uiState.gameContainer.classList.add(this.cameraState.move),this.uiState.buttonsContainer.classList.add("fadeOut"),this.uiState.restartContainer.classList.add("fadeIn-full"),this.uiState.restartContainer.classList.remove("pointer-none"))}initRain=()=>{let A=this.uiState.overlayContainer.getBoundingClientRect(),t=Array.from(this.uiState.overlayContainer.children),j=[];for(let n of t){let s=n.getBoundingClientRect(),i=-(s.top-A.top+s.height/2),o=A.left+A.width-s.left-s.width/2-2;j.push({x:o,y:i,maxX:o,maxY:i}),n.style.transform=`translate(${o}px, ${i}px)`}let r=()=>{t.forEach((n,s)=>{let{x:i,y:o,maxX:a,maxY:k}=j[s],c=A.width<400?1:2,l=i>0?i-c:a,d=o<0?o+c:k;j[s]={x:l,y:d,maxX:a,maxY:k},n.style.transform=`translate(${l}px, ${d}px)`}),requestAnimationFrame(r)};r()};selectCell=async({cellIdx:A})=>{if(!A||!this.map)return;let t=zA(A,this.engine.map_metadata.player_cell_idx,this.map.width);await this.moveWithDelta({delta:t})};moveWithDelta=async({delta:A})=>{if(!A)return;let{x:t,y:j}=pA(this.engine.map_metadata.player_cell_idx,this.engine.width),r={x:t+A[0],y:j+A[1]},n=W.new_with_data(r.x,r.y),s=this.engine.do_move_player(n),i=A[0]<0?K.PlayerMoveL:A[0]>0?K.PlayerMoveR:A[1]<0?K.PlayerMoveU:K.PlayerMoveD;switch(s){case Y.Rejected:{this.playerState.trauma=A[0]<0?m.TraumaL:A[0]>0?m.TraumaR:A[1]<0?m.TraumaU:m.TraumaD,this.playerState.hop=!1,this.playerState.move=K.None,this.cameraState.shake=this.playerState.trauma;break}case Y.Advance:this.cameraState.shake=m.None,this.playerState.trauma=m.None,this.playerState.hop=!0,this.playerState.move=i;break;case Y.NoOp:this.cameraState.shake=m.None,this.playerState.trauma=m.None,this.playerState.hop=!1;break;case Y.End:this.cameraState.shake=m.None,this.cameraState.move=BA.Drama,this.playerState.trauma=m.None,this.playerState.hop=!1,this.uiState.showUI=!1,this.gameState.isGameOver=!0;break}this.engine.do_move_enemy(),await this.tick()};async tick(){if(!this.map)return;this.engine.compute_visibility();let A=this.engine.get_clipped_map_state();this.renderer.updateRendererState({gameMap:{level:A,width:this.map.width,cellWidth:this.map?.cellWidth,viewWidth:this.map?.viewWidth},visibilityState:Array.from(this.engine.visibility_state),particleState:[null,null],playerCellIdx:this.engine.map_metadata.player_cell_idx,playerAnimationState:{...this.playerState,isDead:this.engine.player_poise<=0}}),await this.renderer.render()}async toggleFlashlight({value:A}){this.playerState.isFlashlightOn=!A,this.uiState.flashlightButtonEl.textContent=A?Qe.Off:Qe.On,this.uiState.flashlightButtonEl.classList.add("pointer-none"),await this.tick()}},HA=await Je.init();window.sendDelta=async e=>{HA.sendDelta(e)};window.sendInitialStateVector=async e=>{HA.sendInitialStateVector(e)};
